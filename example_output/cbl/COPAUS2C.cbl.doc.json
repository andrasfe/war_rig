{
  "header": {
    "program_id": "COPAUS2C",
    "file_name": "cbl/COPAUS2C.cbl",
    "file_type": "COBOL",
    "analyzed_by": "WAR_RIG",
    "analyzed_at": "2026-02-24T04:00:46.162862",
    "iteration_count": 1,
    "final_status": null
  },
  "purpose": {
    "summary": "COPAUS2C is a CICS COBOL program in the CardDemo authorization module that marks an authorization message as fraud by inserting a new record into the DB2 AUTHFRDS table or updating an existing one if a duplicate key error occurs. It receives input via CICS COMMAREA including account ID, customer ID, authorization details from CIPAUDTY copybook, and fraud action flag. Upon success or handling duplicates, it updates status fields in COMMAREA and returns to CICS.",
    "business_context": "Card authorization fraud reporting and management in a payment processing demo application",
    "program_type": "ONLINE_CICS",
    "citations": [
      2,
      3,
      4,
      5,
      22,
      73,
      88,
      91,
      141,
      218
    ]
  },
  "inputs": [
    {
      "name": "DFHCOMMAREA",
      "io_type": "CICS_COMMAREA",
      "description": "Contains WS-ACCT-ID, WS-CUST-ID, WS-FRAUD-AUTH-RECORD (authorization details via CIPAUDTY copybook), and WS-FRAUD-STATUS-RECORD (action flag 'F' for fraud or 'R' for remove, update status, and message)",
      "copybook": "CIPAUDTY",
      "citation": [
        74,
        75,
        76,
        77,
        78,
        80
      ]
    }
  ],
  "outputs": [
    {
      "name": "DFHCOMMAREA",
      "io_type": "CICS_COMMAREA",
      "description": "Updated with WS-FRD-UPDT-STATUS ('S' success or 'F' failed) and WS-FRD-ACT-MSG containing success/error details before CICS RETURN",
      "copybook": null,
      "citation": [
        83,
        86,
        200,
        206,
        231,
        234
      ]
    },
    {
      "name": "CARDDEMO.AUTHFRDS",
      "io_type": "DB2_TABLE",
      "description": "Fraud authorization records storing card details, auth timestamp, fraud flag, report date, acct/cust IDs",
      "copybook": "AUTHFRDS",
      "citation": [
        141,
        222
      ]
    }
  ],
  "called_programs": [],
  "calling_context": {
    "called_by": [],
    "entry_points": [],
    "linkage_section": [
      "WS-ACCT-ID",
      "WS-CUST-ID",
      "WS-FRAUD-AUTH-RECORD",
      "WS-FRD-ACTION",
      "WS-FRD-UPDT-STATUS",
      "WS-FRD-ACT-MSG"
    ]
  },
  "business_rules": [
    {
      "rule_id": "BR001",
      "description": "Insert new fraud authorization record into AUTHFRDS using input COMMAREA data and current fraud action flag",
      "logic_summary": "Populate host variables from PA- fields and WS- fields, INSERT with TIMESTAMP_FORMAT for AUTH_TS and CURRENT DATE for FRAUD_RPT_DATE",
      "conditions": [
        "SQLCODE = ZERO"
      ],
      "citation": [
        113,
        137,
        141,
        194
      ]
    },
    {
      "rule_id": "BR002",
      "description": "If INSERT fails with duplicate key error (SQLCODE -803), update existing AUTHFRDS record with fraud flag and current report date",
      "logic_summary": "PERFORM FRAUD-UPDATE to set AUTH_FRAUD = input action and FRAUD_RPT_DATE = CURRENT DATE WHERE CARD_NUM and AUTH_TS match",
      "conditions": [
        "SQLCODE = -803"
      ],
      "citation": [
        203,
        204,
        223,
        225
      ]
    },
    {
      "rule_id": "BR003",
      "description": "Set success status and message on SQLCODE ZERO for INSERT or UPDATE, else set failed and build error message from SQLCODE/SQLSTATE",
      "logic_summary": "Update WS-FRD-UPDT-STATUS and WS-FRD-ACT-MSG accordingly",
      "conditions": [
        "SQLCODE = ZERO",
        "SQLCODE NOT = ZERO AND NOT = -803"
      ],
      "citation": [
        199,
        230,
        206
      ]
    },
    {
      "rule_id": "BR004",
      "description": "Set AUTH_FRAUD field to WS-FRD-ACTION value ('F' report fraud or 'R' remove fraud) unconditionally for both INSERT and UPDATE",
      "logic_summary": "Direct MOVE from WS-FRD-ACTION to AUTH-FRAUD host variable",
      "conditions": [
        "WS-FRD-ACTION = 'F'",
        "WS-FRD-ACTION = 'R'"
      ],
      "citation": [
        80,
        137,
        224
      ]
    }
  ],
  "data_flow": {
    "reads_from": [
      {
        "source": "DFHCOMMAREA",
        "fields_used": [
          "PA-CARD-NUM",
          "PA-AUTH-ORIG-DATE",
          "PA-AUTH-TIME-9C",
          "WS-ACCT-ID",
          "WS-CUST-ID",
          "WS-FRD-ACTION"
        ],
        "citation": [
          75,
          76,
          77,
          80,
          101,
          103,
          107,
          138,
          139
        ]
      }
    ],
    "writes_to": [
      {
        "destination": "CARDDEMO.AUTHFRDS",
        "fields_written": [
          "AUTH_FRAUD",
          "FRAUD_RPT_DATE",
          "ACCT_ID",
          "CUST_ID"
        ],
        "citation": [
          165,
          166,
          167,
          168,
          225
        ]
      },
      {
        "destination": "DFHCOMMAREA",
        "fields_written": [
          "WS-FRD-UPDT-STATUS",
          "WS-FRD-ACT-MSG"
        ],
        "citation": [
          200,
          201,
          206,
          231,
          234
        ]
      }
    ],
    "transforms": [
      {
        "input_field": "PA-AUTH-ORIG-DATE",
        "output_field": "WS-AUTH-TS",
        "transformation_description": "Extract YY, MM, DD from PA-AUTH-ORIG-DATE and combine with computed time components from 999999999 - PA-AUTH-TIME-9C formatted as HH.MI.SS.SSS",
        "citation": [
          103,
          104,
          105,
          107,
          108,
          109,
          110,
          111
        ]
      },
      {
        "input_field": "WS-CUR-DATE",
        "output_field": "PA-FRAUD-RPT-DATE",
        "transformation_description": "MOVE current formatted date from CICS FORMATTIME to PA-FRAUD-RPT-DATE",
        "citation": [
          97,
          101
        ]
      },
      {
        "input_field": "PA-MERCHANT-NAME",
        "output_field": "MERCHANT-NAME-LEN",
        "transformation_description": "Compute LENGTH OF PA-MERCHANT-NAME into MERCHANT-NAME-LEN before MOVE to MERCHANT-NAME-TEXT",
        "citation": [
          130
        ]
      }
    ]
  },
  "copybooks_used": [
    {
      "copybook_name": "DFHBMSCA",
      "purpose": "CICS BMS macro copybook for map and symbolic map definitions",
      "location": "WORKING_STORAGE",
      "citation": 61
    },
    {
      "copybook_name": "CIPAUDTY",
      "purpose": "Defines WS-FRAUD-AUTH-RECORD structure with PA- fields for authorization details like PA-CARD-NUM, PA-AUTH-TYPE",
      "location": "LINKAGE",
      "citation": 78
    },
    {
      "copybook_name": "AUTHFRDS",
      "purpose": "SQL INCLUDE defining host variables for AUTHFRDS table fields like CARD-NUM, AUTH-TS, AUTH-FRAUD",
      "location": "OTHER",
      "citation": 69
    }
  ],
  "paragraphs": [
    {
      "paragraph_name": "MAIN-PARA",
      "summary": null,
      "purpose": "MAIN-PARA serves as the primary entry point and orchestration paragraph for the entire program flow in this CICS transaction. It begins by invoking CICS ASKTIME to get absolute time and FORMATTIME to format the current date into WS-CUR-DATE, which is moved to PA-FRAUD-RPT-DATE for use in SQL. It consumes input data from LINKAGE DFHCOMMAREA, specifically parsing PA-AUTH-ORIG-DATE into date components and computing/formatting WS-AUTH-TIME from PA-AUTH-TIME-9C by subtracting from 999999999 to create a timestamp string WS-AUTH-TS. It then reads numerous PA- fields from the CIPAUDTY copybook structure (e.g., PA-CARD-NUM, PA-AUTH-TYPE, PA-TRANSACTION-AMT) and WS-ACCT-ID/WS-CUST-ID/WS-FRD-ACTION, moving them directly to SQL host variables defined by AUTHFRDS include. The core business logic performs an SQL INSERT into CARDDEMO.AUTHFRDS populating all authorization details, fraud flag from WS-FRD-ACTION, current date for FRAUD_RPT_DATE, and acct/cust IDs; if SQLCODE=0, sets success status/message in COMMAREA; if SQLCODE=-803 (duplicate), PERFORMs FRAUD-UPDATE paragraph; otherwise, builds error message from SQLCODE/SQLSTATE and sets failed status. No explicit file I/O errors beyond SQL are handled here, but SQL error handling decides flow. After processing, it EXEC CICS RETURN to end the transaction, passing updated status back via COMMAREA. This paragraph implements the fraud marking logic idempotently via insert-or-update pattern. It calls FRAUD-UPDATE only on duplicate key to avoid overwriting if record exists.",
      "called_by": [],
      "calls": [
        "FRAUD-UPDATE"
      ],
      "citation": [
        89,
        220
      ],
      "outgoing_calls": [
        {
          "target": "FRAUD-UPDATE",
          "call_type": "performs",
          "line": 204
        },
        {
          "target": "CARDDEMO.AUTHFRDS",
          "call_type": "writes",
          "line": 141
        }
      ],
      "incoming_calls": [],
      "is_dead_code": false,
      "dead_code_reason": null,
      "metadata": {
        "body_chunks": 2
      }
    },
    {
      "paragraph_name": "FRAUD-UPDATE",
      "summary": null,
      "purpose": "FRAUD-UPDATE is a subordinate paragraph invoked only from MAIN-PARA when INSERT fails with SQLCODE=-803 (duplicate key violation). Its primary purpose is to update the existing matching AUTHFRDS record rather than abending, ensuring idempotent fraud flag updates. It consumes host variables already populated in MAIN-PARA, specifically using CARD-NUM and AUTH-TS (formatted timestamp) as the WHERE key to precisely identify the record. It produces an UPDATE to CARDDEMO.AUTHFRDS setting AUTH_FRAUD to the input action flag ('F' or 'R') and FRAUD_RPT_DATE to CURRENT DATE. Business logic checks SQLCODE post-UPDATE: if ZERO, sets WS-FRD-UPDT-SUCCESS and 'UPDT SUCCESS' message; else, sets failed status and builds error string from SQLCODE/SQLSTATE into WS-FRD-ACT-MSG. Error handling mirrors MAIN-PARA by capturing SQL diagnostics but does not propagate further or abend; control returns to caller after status update. No additional paragraphs or programs are called from here. This implements the fallback for duplicate authorizations, maintaining data integrity in fraud reporting. The update ensures the fraud status and report date are refreshed even for existing records.",
      "called_by": [
        "MAIN-PARA"
      ],
      "calls": [],
      "citation": [
        221,
        244
      ],
      "outgoing_calls": [
        {
          "target": "CARDDEMO.AUTHFRDS",
          "call_type": "updates",
          "line": 222
        }
      ],
      "incoming_calls": [
        {
          "file": "/Users/andraslferenczi/war_rig/aws-mainframe-modernization-carddemo/app/app-authorization-ims-db2-mq/cbl/COPAUS2C.cbl",
          "function": "MAIN-PARA",
          "line": 204,
          "call_type": "performs"
        }
      ],
      "is_dead_code": false,
      "dead_code_reason": null,
      "metadata": null
    }
  ],
  "error_handling": [
    {
      "condition": "SQLCODE NOT = ZERO after INSERT",
      "action": "If -803, PERFORM FRAUD-UPDATE; else set WS-FRD-UPDT-FAILED and build error message from WS-SQLCODE/WS-SQLSTATE",
      "citation": [
        199,
        203,
        206
      ]
    },
    {
      "condition": "SQLCODE NOT = ZERO after UPDATE",
      "action": "Set WS-FRD-UPDT-FAILED and build error message from WS-SQLCODE/WS-SQLSTATE into WS-FRD-ACT-MSG",
      "citation": [
        230,
        234
      ]
    }
  ],
  "sql_operations": [
    {
      "operation": "INSERT",
      "table": "CARDDEMO.AUTHFRDS",
      "purpose": "Insert new fraud-marked authorization record with all details from input, fraud flag, current report date",
      "citation": 141
    },
    {
      "operation": "UPDATE",
      "table": "CARDDEMO.AUTHFRDS",
      "purpose": "Update existing record's AUTH_FRAUD and FRAUD_RPT_DATE for matching CARD_NUM and AUTH_TS on duplicate insert attempt",
      "citation": 222
    }
  ],
  "cics_operations": [
    {
      "command": "ASKTIME",
      "resource": "ABSTIME",
      "purpose": "Retrieve absolute current timestamp into WS-ABS-TIME for date formatting",
      "citation": 91
    },
    {
      "command": "FORMATTIME",
      "resource": "ABSTIME",
      "purpose": "Format WS-ABS-TIME into MMDDYY date string WS-CUR-DATE using DATESEP",
      "citation": 95
    },
    {
      "command": "RETURN",
      "resource": null,
      "purpose": "Return control to CICS with updated COMMAREA containing status and message",
      "citation": 218
    }
  ],
  "open_questions": [],
  "resolved_questions": [],
  "dead_code": [],
  "call_semantics": [
    {
      "caller": "MAIN-PARA",
      "callee": "FRAUD-UPDATE",
      "inputs": [],
      "outputs": [],
      "purpose": null
    }
  ],
  "flow_diagram": "flowchart TD\n    %% Title: COPAUS2C.cbl\n    FRAUD_UPDATE[\"FRAUD-UPDATE\"]\n    CARDDEMO_AUTHFRDS__ext[(\"CARDDEMO.AUTHFRDS\")]\n    MAIN_PARA[\"MAIN-PARA\"]\n    FRAUD_UPDATE -.->|updates| CARDDEMO_AUTHFRDS__ext\n    MAIN_PARA --> FRAUD_UPDATE\n    MAIN_PARA -.->|writes| CARDDEMO_AUTHFRDS__ext"
}