{
  "header": {
    "program_id": "COPAUS2C",
    "file_name": "cbl/COPAUS2C.cbl",
    "file_type": "COBOL",
    "analyzed_by": "WAR_RIG",
    "analyzed_at": "2026-01-26T17:37:29.459364",
    "iteration_count": 1,
    "final_status": null
  },
  "purpose": {
    "summary": "This CICS COBOL program receives authorization transaction data via commarea, formats timestamps, and inserts a new record into the CARDDEMO.AUTHFRDS DB2 table to mark the authorization as fraud based on the action flag. If the insert fails due to duplicate key (SQLCODE -803), it updates the existing matching record instead. It sets success or failure status and message in the commarea before returning to CICS.",
    "business_context": "CardDemo application Authorization Module for marking fraud on authorization messages",
    "program_type": "ONLINE_CICS",
    "citations": [
      2,
      3,
      4,
      5,
      73,
      141,
      203,
      218
    ]
  },
  "inputs": [
    {
      "name": "DFHCOMMAREA",
      "io_type": "CICS_COMMAREA",
      "description": "Linkage area containing WS-ACCT-ID, WS-CUST-ID, WS-FRAUD-AUTH-RECORD (PA- fields from CIPAUDTY), and WS-FRAUD-STATUS-RECORD (action flag, status, message)",
      "copybook": "CIPAUDTY",
      "citation": [
        73,
        75,
        76,
        77,
        80
      ]
    },
    {
      "name": "CICS_ABSTIME",
      "io_type": "CICS_COMMAREA",
      "description": "Current absolute time retrieved via ASKTIME for date/time formatting",
      "copybook": null,
      "citation": [
        91
      ]
    }
  ],
  "outputs": [
    {
      "name": "CARDDEMO.AUTHFRDS",
      "io_type": "DB2_TABLE",
      "description": "Table storing fraud-marked authorization records with details like card number, auth timestamp, fraud flag, report date, acct/cust IDs",
      "copybook": "AUTHFRDS",
      "citation": [
        141,
        222
      ]
    },
    {
      "name": "DFHCOMMAREA",
      "io_type": "CICS_COMMAREA",
      "description": "Updated with WS-FRD-UPDT-STATUS and WS-FRD-ACT-MSG reflecting insert/update success or failure",
      "copybook": null,
      "citation": [
        200,
        206,
        231,
        234
      ]
    }
  ],
  "called_programs": [],
  "calling_context": {
    "called_by": [],
    "entry_points": [],
    "linkage_section": [
      "DFHCOMMAREA",
      "WS-ACCT-ID",
      "WS-CUST-ID",
      "WS-FRAUD-AUTH-RECORD",
      "WS-FRD-ACTION"
    ]
  },
  "business_rules": [
    {
      "rule_id": "BR001",
      "description": "Attempt INSERT into AUTHFRDS; on duplicate key SQLCODE -803, perform UPDATE instead to mark existing auth record as fraud",
      "logic_summary": "IF SQLCODE = ZERO success ELSE IF SQLCODE = -803 PERFORM FRAUD-UPDATE ELSE failure with error message",
      "conditions": [
        "SQLCODE = ZERO",
        "SQLCODE = -803"
      ],
      "citation": [
        199,
        203
      ]
    },
    {
      "rule_id": "BR002",
      "description": "Set AUTH_FRAUD flag from WS-FRD-ACTION ('F' for fraud report, 'R' for remove)",
      "logic_summary": "MOVE WS-FRD-ACTION TO AUTH-FRAUD before INSERT/UPDATE",
      "conditions": [
        "WS-FRD-ACTION = 'F'",
        "WS-FRD-ACTION = 'R'"
      ],
      "citation": [
        137,
        80,
        81,
        82
      ]
    }
  ],
  "data_flow": {
    "reads_from": [
      {
        "source": "DFHCOMMAREA",
        "fields_used": [
          "WS-ACCT-ID",
          "WS-CUST-ID",
          "PA-AUTH-ORIG-DATE",
          "PA-AUTH-TIME-9C",
          "PA-CARD-NUM",
          "WS-FRD-ACTION"
        ],
        "citation": [
          75,
          76,
          77,
          103,
          107,
          113,
          137
        ]
      }
    ],
    "writes_to": [
      {
        "destination": "CARDDEMO.AUTHFRDS",
        "fields_written": [
          "AUTH_FRAUD",
          "FRAUD_RPT_DATE",
          "ACCT_ID",
          "CUST_ID"
        ],
        "citation": [
          165,
          166,
          167,
          168,
          224,
          225
        ]
      },
      {
        "destination": "DFHCOMMAREA",
        "fields_written": [
          "WS-FRD-UPDT-STATUS",
          "WS-FRD-ACT-MSG"
        ],
        "citation": [
          200,
          201,
          206,
          231,
          234
        ]
      }
    ],
    "transforms": [
      {
        "input_field": "WS-ABS-TIME",
        "output_field": "WS-CUR-DATE",
        "transformation_description": "Format absolute time to MMDDYY date string via CICS FORMATTIME",
        "citation": [
          95
        ]
      },
      {
        "input_field": "PA-AUTH-TIME-9C",
        "output_field": "WS-AUTH-TS",
        "transformation_description": "Compute 999999999 - PA-AUTH-TIME-9C then parse to YY-MM-DD HH.MI.SS SSS format",
        "citation": [
          107
        ]
      },
      {
        "input_field": "PA-MERCHANT-NAME",
        "output_field": "MERCHANT-NAME-LEN",
        "transformation_description": "Compute LENGTH OF PA-MERCHANT-NAME for variable length field",
        "citation": [
          130
        ]
      }
    ]
  },
  "copybooks_used": [
    {
      "copybook_name": "CIPAUDTY",
      "purpose": "Defines structure of WS-FRAUD-AUTH-RECORD containing PA- prefixed authorization fields like PA-CARD-NUM, PA-AUTH-TYPE",
      "location": "LINKAGE",
      "citation": 78
    },
    {
      "copybook_name": "AUTHFRDS",
      "purpose": "SQL INCLUDE declaring host variables for AUTHFRDS table fields like CARD-NUM, AUTH-TS, AUTH-FRAUD",
      "location": "WORKING_STORAGE",
      "citation": 69
    }
  ],
  "paragraphs": [
    {
      "paragraph_name": "MAIN-PARA",
      "summary": null,
      "purpose": "This is the main orchestration paragraph serving as the program's entry point and controlling the entire transaction flow in this CICS program. It first retrieves the current absolute time via EXEC CICS ASKTIME into WS-ABS-TIME and formats it to MMDDYY date string in WS-CUR-DATE using FORMATTIME, then moves this to PA-FRAUD-RPT-DATE in the linkage commarea. It consumes PA-AUTH-ORIG-DATE from the CIPAUDTY copybook record to populate date parts (YY, MM, DD) in WS-AUTH-TS and computes authorization time by subtracting PA-AUTH-TIME-9C from 999999999, parsing the result into HH, MI, SS, SSS for a full timestamp in WS-AUTH-TS. The paragraph reads extensively from linkage DFHCOMMAREA fields including all PA- prefixed authorization details, WS-ACCT-ID, WS-CUST-ID, and WS-FRD-ACTION, moving them to SQL host variables such as CARD-NUM, AUTH-TYPE, TRANSACTION-AMT, MERCHANT-ID, AUTH-FRAUD, etc., and computes MERCHANT-NAME-LEN. It then performs an EXEC SQL INSERT into CARDDEMO.AUTHFRDS populating 22 fields with the prepared data, using TIMESTAMP_FORMAT on AUTH-TS and CURRENT DATE for FRAUD_RPT_DATE. Business logic checks SQLCODE post-INSERT: if 0, sets WS-FRD-UPDT-SUCCESS and 'ADD SUCCESS' message; if -803 (duplicate), PERFORMs FRAUD-UPDATE; else sets failure, captures WS-SQLCODE/WS-SQLSTATE, and STRINGs error into WS-FRD-ACT-MSG. Error handling is SQLCODE-driven with no abend, just status updates in commarea. It calls FRAUD-UPDATE conditionally for duplicate handling. Finally, EXEC CICS RETURN releases control back to CICS with updated commarea.",
      "called_by": [],
      "calls": [
        "FRAUD-UPDATE"
      ],
      "citation": [
        89,
        220
      ],
      "outgoing_calls": [],
      "incoming_calls": [],
      "metadata": null
    },
    {
      "paragraph_name": "FRAUD-UPDATE",
      "summary": null,
      "purpose": "This paragraph handles the duplicate key scenario from MAIN-PARA by updating an existing AUTHFRDS record instead of inserting a new one. It consumes host variables prepared in MAIN-PARA, specifically CARD-NUM, AUTH-TS (timestamp formatted), and AUTH-FRAUD (from WS-FRD-ACTION). Its primary role is to execute an EXEC SQL UPDATE on CARDDEMO.AUTHFRDS setting AUTH_FRAUD = :AUTH-FRAUD and FRAUD_RPT_DATE = CURRENT DATE WHERE CARD_NUM = :CARD-NUM AND AUTH_TS matches the formatted timestamp. No additional data reads or complex validations; it relies on the uniqueness of CARD_NUM + AUTH_TS for targeting the record. Post-UPDATE, it checks SQLCODE: if 0, sets WS-FRD-UPDT-SUCCESS and moves 'UPDT SUCCESS' to WS-FRD-ACT-MSG; else sets WS-FRD-UPDT-FAILED, captures SQLCODE/SQLSTATE to WS-SQLCODE/WS-SQLSTATE, and STRINGs 'UPDT ERROR DB2: CODE: ... STATE: ...' into WS-FRD-ACT-MSG. Error handling mirrors MAIN-PARA's SQL failure path, updating commarea status without abending. It produces database updates to fraud flag and report date on the matching record, and modifies linkage WS-FRD-STATUS-RECORD fields. No subordinate calls or loops; execution is linear and terminates implicitly after status set. This implements the business rule for idempotent fraud marking on potential duplicates.",
      "called_by": [
        "MAIN-PARA"
      ],
      "calls": [],
      "citation": [
        221,
        244
      ],
      "outgoing_calls": [],
      "incoming_calls": [],
      "metadata": null
    }
  ],
  "error_handling": [
    {
      "condition": "SQLCODE NOT = 0 after INSERT",
      "action": "IF SQLCODE = -803 PERFORM FRAUD-UPDATE ELSE SET WS-FRD-UPDT-FAILED and STRING error to WS-FRD-ACT-MSG",
      "citation": [
        199
      ]
    },
    {
      "condition": "SQLCODE NOT = 0 after UPDATE",
      "action": "SET WS-FRD-UPDT-FAILED and STRING 'UPDT ERROR DB2: CODE: ... STATE: ...' to WS-FRD-ACT-MSG",
      "citation": [
        230
      ]
    }
  ],
  "sql_operations": [
    {
      "operation": "INSERT",
      "table": "CARDDEMO.AUTHFRDS",
      "purpose": "Insert new authorization record marked as fraud with report date, acct/cust IDs",
      "citation": 141
    },
    {
      "operation": "UPDATE",
      "table": "CARDDEMO.AUTHFRDS",
      "purpose": "Update existing authorization record to set fraud flag and report date on duplicate key match",
      "citation": 222
    }
  ],
  "cics_operations": [
    {
      "command": "ASKTIME",
      "resource": "ABSTIME",
      "purpose": "Retrieve current absolute time for date formatting",
      "citation": 91
    },
    {
      "command": "FORMATTIME",
      "resource": "ABSTIME",
      "purpose": "Format abstime to MMDDYY date string",
      "citation": 95
    },
    {
      "command": "RETURN",
      "resource": null,
      "purpose": "Return control to CICS with updated commarea",
      "citation": 218
    }
  ],
  "open_questions": []
}