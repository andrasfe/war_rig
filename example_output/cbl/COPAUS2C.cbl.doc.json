{
  "header": {
    "program_id": "COPAUS2C",
    "file_name": "COPAUS2C.cbl",
    "file_type": "COBOL",
    "analyzed_by": "WAR_RIG",
    "analyzed_at": "2026-01-27T23:04:57.421331",
    "iteration_count": 1,
    "final_status": null
  },
  "purpose": {
    "summary": "COPAUS2C is a CICS COBOL program that marks authorization messages as fraudulent by inserting or updating records in the CARDDEMO.AUTHFRDS table. It receives transaction details via the CICS COMMAREA, formats the data, and then performs the SQL INSERT or UPDATE operation.",
    "business_context": "This program is part of the CardDemo application's authorization module, used to flag potentially fraudulent transactions.",
    "program_type": "ONLINE_CICS",
    "citations": [
      2,
      4,
      5,
      142,
      223
    ]
  },
  "inputs": [
    {
      "name": "DFHCOMMAREA",
      "io_type": "CICS_COMMAREA",
      "description": "CICS COMMAREA containing transaction details, account ID, customer ID, and fraud action.",
      "copybook": "CIPAUDTY",
      "citation": [
        74,
        78
      ]
    },
    {
      "name": "CARDDEMO.AUTHFRDS",
      "io_type": "DB2_TABLE",
      "description": "DB2 table containing authorization details and fraud flags.",
      "copybook": "AUTHFRDS",
      "citation": [
        142,
        223
      ]
    }
  ],
  "outputs": [
    {
      "name": "CARDDEMO.AUTHFRDS",
      "io_type": "DB2_TABLE",
      "description": "Updated with fraud status for the transaction.",
      "copybook": null,
      "citation": [
        142,
        223
      ]
    },
    {
      "name": "DFHCOMMAREA",
      "io_type": "CICS_COMMAREA",
      "description": "Updated with fraud update status and action message.",
      "copybook": null,
      "citation": [
        83,
        86,
        201,
        232
      ]
    }
  ],
  "called_programs": [],
  "calling_context": {
    "called_by": [],
    "entry_points": [],
    "linkage_section": [
      "DFHCOMMAREA"
    ]
  },
  "business_rules": [
    {
      "rule_id": "BR001",
      "description": "If a record with the same card number and timestamp already exists, update the AUTH_FRAUD and FRAUD_RPT_DATE fields. Otherwise, insert a new record.",
      "logic_summary": "The program attempts to insert a new record into the AUTHFRDS table. If a duplicate key error occurs (SQLCODE = -803), it performs an update instead.",
      "conditions": [
        "SQLCODE = ZERO (Insert successful)",
        "SQLCODE = -803 (Duplicate key, update required)"
      ],
      "citation": [
        199,
        203,
        221
      ]
    }
  ],
  "data_flow": {
    "reads_from": [
      {
        "source": "DFHCOMMAREA",
        "fields_used": [
          "PA-CARD-NUM",
          "PA-AUTH-ORIG-DATE",
          "PA-AUTH-TIME-9C",
          "PA-AUTH-TYPE",
          "PA-CARD-EXPIRY-DATE",
          "PA-MESSAGE-TYPE",
          "PA-MESSAGE-SOURCE",
          "PA-AUTH-ID-CODE",
          "PA-AUTH-RESP-CODE",
          "PA-AUTH-RESP-REASON",
          "PA-PROCESSING-CODE",
          "PA-TRANSACTION-AMT",
          "PA-APPROVED-AMT",
          "PA-MERCHANT-CATAGORY-CODE",
          "PA-ACQR-COUNTRY-CODE",
          "PA-POS-ENTRY-MODE",
          "PA-MERCHANT-ID",
          "PA-MERCHANT-NAME",
          "PA-MERCHANT-CITY",
          "PA-MERCHANT-STATE",
          "PA-MERCHANT-ZIP",
          "PA-TRANSACTION-ID",
          "PA-MATCH-STATUS"
        ],
        "citation": [
          103,
          113,
          115,
          116,
          117,
          118,
          119,
          120,
          121,
          122,
          123,
          124,
          125,
          127,
          128,
          129,
          131,
          132,
          133,
          134,
          135,
          136
        ]
      },
      {
        "source": "WS-ACCT-ID",
        "fields_used": [
          "WS-ACCT-ID"
        ],
        "citation": [
          138
        ]
      },
      {
        "source": "WS-CUST-ID",
        "fields_used": [
          "WS-CUST-ID"
        ],
        "citation": [
          139
        ]
      },
      {
        "source": "WS-FRD-ACTION",
        "fields_used": [
          "WS-FRD-ACTION"
        ],
        "citation": [
          137
        ]
      }
    ],
    "writes_to": [
      {
        "destination": "CARDDEMO.AUTHFRDS",
        "fields_written": [
          "CARD_NUM",
          "AUTH_TS",
          "AUTH_TYPE",
          "CARD_EXPIRY_DATE",
          "MESSAGE_TYPE",
          "MESSAGE_SOURCE",
          "AUTH_ID_CODE",
          "AUTH_RESP_CODE",
          "AUTH_RESP_REASON",
          "PROCESSING_CODE",
          "TRANSACTION_AMT",
          "APPROVED_AMT",
          "MERCHANT_CATAGORY_CODE",
          "ACQR_COUNTRY_CODE",
          "POS_ENTRY_MODE",
          "MERCHANT_ID",
          "MERCHANT_NAME",
          "MERCHANT_CITY",
          "MERCHANT_STATE",
          "MERCHANT_ZIP",
          "TRANSACTION_ID",
          "MATCH_STATUS",
          "AUTH_FRAUD",
          "FRAUD_RPT_DATE",
          "ACCT_ID",
          "CUST_ID"
        ],
        "citation": [
          143,
          224
        ]
      },
      {
        "destination": "DFHCOMMAREA",
        "fields_written": [
          "WS-FRD-UPDATE-STATUS",
          "WS-FRD-ACT-MSG"
        ],
        "citation": [
          200,
          201,
          206,
          211,
          231,
          232,
          234,
          239
        ]
      }
    ],
    "transforms": [
      {
        "input_field": "PA-AUTH-ORIG-DATE",
        "output_field": "WS-AUTH-YY, WS-AUTH-MM, WS-AUTH-DD",
        "transformation_description": "Extracts year, month, and day from PA-AUTH-ORIG-DATE.",
        "citation": [
          103,
          104,
          105
        ]
      },
      {
        "input_field": "PA-AUTH-TIME-9C",
        "output_field": "WS-AUTH-TIME",
        "transformation_description": "Calculates WS-AUTH-TIME by subtracting PA-AUTH-TIME-9C from 999999999.",
        "citation": [
          107
        ]
      },
      {
        "input_field": "WS-AUTH-TIME-AN",
        "output_field": "WS-AUTH-HH, WS-AUTH-MI, WS-AUTH-SS, WS-AUTH-SSS",
        "transformation_description": "Extracts hours, minutes, seconds, and milliseconds from WS-AUTH-TIME-AN.",
        "citation": [
          108,
          109,
          110,
          111
        ]
      },
      {
        "input_field": "WS-AUTH-TS",
        "output_field": "AUTH_TS (DB2)",
        "transformation_description": "Formats WS-AUTH-TS into a timestamp suitable for DB2 insertion/update.",
        "citation": [
          114,
          171,
          227
        ]
      },
      {
        "input_field": "PA-MERCHANT-NAME",
        "output_field": "MERCHANT-NAME",
        "transformation_description": "Moves the merchant name and its length to the corresponding fields.",
        "citation": [
          130,
          131
        ]
      }
    ]
  },
  "copybooks_used": [
    {
      "copybook_name": "DFHBMSCA",
      "purpose": "CICS BMS communication area definitions (commented out)",
      "location": "WORKING_STORAGE",
      "citation": 61
    },
    {
      "copybook_name": "SQLCA",
      "purpose": "SQL communication area for DB2 interaction.",
      "location": "WORKING_STORAGE",
      "citation": 66
    },
    {
      "copybook_name": "AUTHFRDS",
      "purpose": "Defines the structure of the AUTHFRDS table for SQL operations.",
      "location": "WORKING_STORAGE",
      "citation": 69
    },
    {
      "copybook_name": "CIPAUDTY",
      "purpose": "Defines the structure of the fraud authorization record.",
      "location": "LINKAGE",
      "citation": 78
    }
  ],
  "paragraphs": [
    {
      "paragraph_name": "MAIN-PARA",
      "summary": null,
      "purpose": "The MAIN-PARA paragraph is the main control flow of the COPAUS2C program. It begins by retrieving the current date and time using CICS ASKTIME and FORMATTIME commands and storing them in WS-ABS-TIME and WS-CUR-DATE respectively. It then extracts the year, month, and day from the PA-AUTH-ORIG-DATE field in the COMMAREA and stores them in WS-AUTH-YY, WS-AUTH-MM and WS-AUTH-DD. Next, it computes the authorization time by subtracting PA-AUTH-TIME-9C from 999999999 and formats the time components into WS-AUTH-HH, WS-AUTH-MI, WS-AUTH-SS, and WS-AUTH-SSS. It moves data from the COMMAREA into host variables for the SQL INSERT statement. The program then executes an SQL INSERT statement to add a new record to the CARDDEMO.AUTHFRDS table, marking the authorization message as fraudulent. If the insert is successful (SQLCODE = ZERO), it sets WS-FRD-UPDT-SUCCESS to TRUE and moves 'ADD SUCCESS' to WS-FRD-ACT-MSG. If a duplicate key error occurs (SQLCODE = -803), it calls the FRAUD-UPDATE paragraph to update the existing record. If any other SQL error occurs, it sets WS-FRD-UPDT-FAILED to TRUE and constructs an error message in WS-FRD-ACT-MSG. Finally, it returns control to CICS.",
      "called_by": [],
      "calls": [
        "FRAUD-UPDATE"
      ],
      "citation": [
        89,
        220
      ],
      "outgoing_calls": [
        {
          "target": "FRAUD-UPDATE",
          "call_type": "performs",
          "line": 204
        },
        {
          "target": "CARDDEMO.AUTHFRDS",
          "call_type": "writes",
          "line": 141
        }
      ],
      "incoming_calls": [],
      "is_dead_code": false,
      "dead_code_reason": null,
      "metadata": {
        "body_chunks": 2
      }
    },
    {
      "paragraph_name": "FRAUD-UPDATE",
      "summary": null,
      "purpose": "The FRAUD-UPDATE paragraph is called when an attempt to insert a new fraud record fails due to a duplicate key (SQLCODE = -803). This paragraph updates the existing record in the CARDDEMO.AUTHFRDS table with the fraud information. It executes an SQL UPDATE statement, setting the AUTH_FRAUD and FRAUD_RPT_DATE fields for the record matching the CARD_NUM and AUTH_TS. If the update is successful (SQLCODE = ZERO), it sets WS-FRD-UPDT-SUCCESS to TRUE and moves 'UPDT SUCCESS' to WS-FRD-ACT-MSG. If the update fails (SQLCODE is not ZERO), it sets WS-FRD-UPDT-FAILED to TRUE and constructs an error message in WS-FRD-ACT-MSG, including the SQLCODE and SQLSTATE. This paragraph consumes the host variables populated in MAIN-PARA, specifically CARD-NUM, AUTH-TS, and AUTH-FRAUD. It updates the CARDDEMO.AUTHFRDS table and sets the WS-FRD-UPDT-SUCCESS flag in the COMMAREA. No other paragraphs or programs are called from this paragraph. The paragraph concludes by returning to the calling paragraph (MAIN-PARA).",
      "called_by": [
        "MAIN-PARA"
      ],
      "calls": [],
      "citation": [
        221,
        244
      ],
      "outgoing_calls": [
        {
          "target": "CARDDEMO.AUTHFRDS",
          "call_type": "updates",
          "line": 222
        }
      ],
      "incoming_calls": [
        {
          "file": "/home/andras/aws-mainframe-modernization-carddemo/app/app-authorization-ims-db2-mq/cbl/COPAUS2C.cbl",
          "function": "MAIN-PARA",
          "line": 204,
          "call_type": "performs"
        }
      ],
      "is_dead_code": false,
      "dead_code_reason": null,
      "metadata": null
    }
  ],
  "error_handling": [
    {
      "condition": "SQLCODE = -803 (Duplicate Key)",
      "action": "PERFORM FRAUD-UPDATE to update the existing record.",
      "citation": [
        203,
        204
      ]
    },
    {
      "condition": "SQLCODE not ZERO and not -803",
      "action": "SET WS-FRD-UPDT-FAILED to TRUE and construct an error message in WS-FRD-ACT-MSG with SQLCODE and SQLSTATE.",
      "citation": [
        206,
        211
      ]
    },
    {
      "condition": "SQLCODE not ZERO in FRAUD-UPDATE",
      "action": "SET WS-FRD-UPDT-FAILED to TRUE and construct an error message in WS-FRD-ACT-MSG with SQLCODE and SQLSTATE.",
      "citation": [
        234,
        239
      ]
    }
  ],
  "sql_operations": [
    {
      "operation": "INSERT",
      "table": "CARDDEMO.AUTHFRDS",
      "purpose": "Insert a new record indicating a fraudulent authorization.",
      "citation": 142
    },
    {
      "operation": "UPDATE",
      "table": "CARDDEMO.AUTHFRDS",
      "purpose": "Update an existing record to mark it as fraudulent.",
      "citation": 223
    }
  ],
  "cics_operations": [
    {
      "command": "ASKTIME",
      "resource": null,
      "purpose": "Get the current absolute time.",
      "citation": 91
    },
    {
      "command": "FORMATTIME",
      "resource": null,
      "purpose": "Format the absolute time into a MMDDYY date format.",
      "citation": 95
    },
    {
      "command": "RETURN",
      "resource": null,
      "purpose": "Return control to the calling CICS program.",
      "citation": 218
    }
  ],
  "open_questions": [],
  "dead_code": [],
  "flow_diagram": "flowchart TD\n    %% Title: COPAUS2C.cbl\n    FRAUD_UPDATE[\"FRAUD-UPDATE\"]\n    CARDDEMO_AUTHFRDS__ext[(\"CARDDEMO.AUTHFRDS\")]\n    MAIN_PARA[\"MAIN-PARA\"]\n    FRAUD_UPDATE -.->|updates| CARDDEMO_AUTHFRDS__ext\n    MAIN_PARA --> FRAUD_UPDATE\n    MAIN_PARA -.->|writes| CARDDEMO_AUTHFRDS__ext"
}