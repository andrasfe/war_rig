{
  "header": {
    "program_id": "COPAUS2C",
    "file_name": "cbl/COPAUS2C.cbl",
    "file_type": "COBOL",
    "analyzed_by": "WAR_RIG",
    "analyzed_at": "2026-01-27T02:40:29.241777",
    "iteration_count": 1,
    "final_status": null
  },
  "purpose": {
    "summary": "This CICS COBOL program receives authorization details and fraud marking instructions via COMMAREA, formats timestamps, and inserts a new record into the CARDDEMO.AUTHFRDS DB2 table to mark the authorization as fraud. If the record already exists (SQLCODE -803), it performs an UPDATE to set the fraud flag and report date instead. Upon completion, it sets the status in the output COMMAREA and returns to CICS.",
    "business_context": "CardDemo application - Authorization Module for marking fraudulent authorization messages.",
    "program_type": "ONLINE_CICS",
    "citations": [
      2,
      3,
      5,
      141,
      222
    ]
  },
  "inputs": [
    {
      "name": "DFHCOMMAREA",
      "io_type": "CICS_COMMAREA",
      "description": "Contains account ID, customer ID, fraud authorization record details (PA- fields from CIPAUDTY copybook), and fraud status record including action flag ('F' for report fraud).",
      "copybook": "CIPAUDTY",
      "citation": [
        73,
        75,
        76,
        78,
        80
      ]
    }
  ],
  "outputs": [
    {
      "name": "CARDDEMO.AUTHFRDS",
      "io_type": "DB2_TABLE",
      "description": "DB2 table storing authorization fraud details; new records inserted or existing updated with fraud flag, report date, and related transaction data.",
      "copybook": "AUTHFRDS",
      "citation": [
        142,
        223
      ]
    },
    {
      "name": "DFHCOMMAREA",
      "io_type": "CICS_COMMAREA",
      "description": "Updated with fraud status record indicating success/failure and message.",
      "copybook": null,
      "citation": [
        200,
        231
      ]
    }
  ],
  "called_programs": [],
  "calling_context": {
    "called_by": [],
    "entry_points": [],
    "linkage_section": [
      "WS-ACCT-ID",
      "WS-CUST-ID",
      "WS-FRAUD-STATUS-RECORD"
    ]
  },
  "business_rules": [
    {
      "rule_id": "BR001",
      "description": "Handle duplicate key on INSERT by updating the existing record instead of failing.",
      "logic_summary": "After INSERT, if SQLCODE = 0 set success; if -803 perform UPDATE; else set failure with error details.",
      "conditions": [
        "SQLCODE = ZERO",
        "SQLCODE = -803",
        "SQLCODE NOT = 0 OR -803"
      ],
      "citation": [
        199,
        203,
        206
      ]
    }
  ],
  "data_flow": {
    "reads_from": [
      {
        "source": "DFHCOMMAREA",
        "fields_used": [
          "WS-ACCT-ID",
          "WS-CUST-ID",
          "WS-FRD-ACTION",
          "PA-AUTH-ORIG-DATE",
          "PA-AUTH-TIME-9C",
          "PA-CARD-NUM"
        ],
        "citation": [
          75,
          76,
          80,
          101,
          107,
          113
        ]
      }
    ],
    "writes_to": [
      {
        "destination": "CARDDEMO.AUTHFRDS",
        "fields_written": [
          "AUTH_FRAUD",
          "FRAUD_RPT_DATE",
          "ACCT_ID",
          "CUST_ID"
        ],
        "citation": [
          224,
          225
        ]
      }
    ],
    "transforms": [
      {
        "input_field": "PA-AUTH-ORIG-DATE",
        "output_field": "WS-AUTH-TS",
        "transformation_description": "Parsed into YY-MM-DD HH.MI.SS SSS format from MMDDYY.",
        "citation": [
          103
        ]
      },
      {
        "input_field": "PA-AUTH-TIME-9C",
        "output_field": "WS-AUTH-TIME",
        "transformation_description": "Computed as 999999999 minus input packed time value.",
        "citation": [
          107
        ]
      },
      {
        "input_field": "WS-FRD-ACTION",
        "output_field": "AUTH-FRAUD",
        "transformation_description": "Direct move of fraud action flag ('F') to table field.",
        "citation": [
          137
        ]
      }
    ]
  },
  "copybooks_used": [
    {
      "copybook_name": "CIPAUDTY",
      "purpose": "Defines structure of WS-FRAUD-AUTH-RECORD with authorization details (PA-AUTH-ORIG-DATE, PA-CARD-NUM, etc.).",
      "location": "LINKAGE",
      "citation": 78
    },
    {
      "copybook_name": "DFHBMSCA",
      "purpose": "CICS BMS standard copybook for map handling (appears commented).",
      "location": "WORKING_STORAGE",
      "citation": 61
    }
  ],
  "paragraphs": [
    {
      "paragraph_name": "MAIN-PARA",
      "summary": null,
      "purpose": "This is the main orchestration paragraph serving as the program's entry point and controlling the entire fraud marking process. It consumes inputs from the DFHCOMMAREA linkage section, including WS-ACCT-ID, WS-CUST-ID, WS-FRD-ACTION, and numerous PA- fields from the CIPAUDTY copybook structure within WS-FRAUD-AUTH-RECORD. It first obtains current time via CICS ASKTIME (91) and formats the date via FORMATTIME into WS-CUR-DATE, moving it to PA-FRAUD-RPT-DATE (101). It then parses PA-AUTH-ORIG-DATE into date components (103-105) and computes/formats WS-AUTH-TIME from PA-AUTH-TIME-9C (107-111). Next, it moves all relevant input fields to SQL host variables (e.g., CARD-NUM from PA-CARD-NUM at 113, AUTH-FRAUD from WS-FRD-ACTION at 137, up to CUST-ID at 139). The core business logic performs SQL INSERT into AUTHFRDS with formatted timestamp and CURRENT DATE (141-198), deciding based on SQLCODE: success if 0 (sets WS-FRD-UPDT-SUCCESS and message 200-201), duplicate handling via PERFORM FRAUD-UPDATE if -803 (204), or failure with error message construction using WS-SQLCODE/STATE (206-214). Outputs include the updated DB2 table and modified WS-FRAUD-STATUS-RECORD in COMMAREA. Error handling covers SQL errors post-INSERT but uses NOHANDLE for CICS commands. It calls FRAUD-UPDATE conditionally for duplicates. Finally, it executes CICS RETURN (218) to end the transaction.",
      "called_by": [],
      "calls": [
        "FRAUD-UPDATE"
      ],
      "citation": [
        89,
        220
      ],
      "outgoing_calls": [],
      "incoming_calls": [],
      "is_dead_code": false,
      "dead_code_reason": null,
      "metadata": null
    },
    {
      "paragraph_name": "FRAUD-UPDATE",
      "summary": null,
      "purpose": "This paragraph performs the SQL UPDATE for existing AUTHFRDS records when INSERT detects a duplicate key (SQLCODE -803). It consumes host variables populated in MAIN-PARA, specifically CARD-NUM, AUTH-TS (formatted), AUTH-FRAUD, using them in the WHERE clause and SET for AUTH_FRAUD and FRAUD_RPT_DATE = CURRENT DATE (222-228). The primary purpose is to overwrite the fraud status on matching card number and auth timestamp without inserting a new record. It produces updates to the DB2 table and sets WS-FRD-STATUS-RECORD accordingly. Business logic checks SQLCODE post-UPDATE: if 0, sets WS-FRD-UPDT-SUCCESS and 'UPDT SUCCESS' message (231-232); else sets WS-FRD-UPDT-FAILED and builds error string with SQLCODE/SQLSTATE (234-241). No additional validations or conditions are checked beyond SQL success. Error handling is SQLCODE-based, mirroring MAIN-PARA. It makes no calls to other paragraphs or programs. Control returns implicitly to MAIN-PARA after PERFORM completion.",
      "called_by": [
        "MAIN-PARA"
      ],
      "calls": [],
      "citation": [
        221,
        244
      ],
      "outgoing_calls": [],
      "incoming_calls": [],
      "is_dead_code": false,
      "dead_code_reason": null,
      "metadata": null
    }
  ],
  "error_handling": [
    {
      "condition": "SQLCODE NOT = 0 after INSERT",
      "action": "If SQLCODE = -803 PERFORM FRAUD-UPDATE; ELSE set WS-FRD-UPDT-FAILED TRUE, populate WS-SQLCODE/WS-SQLSTATE, build WS-FRD-ACT-MSG with error details.",
      "citation": [
        199
      ]
    },
    {
      "condition": "SQLCODE NOT = 0 after UPDATE",
      "action": "Set WS-FRD-UPDT-FAILED TRUE, populate WS-SQLCODE/WS-SQLSTATE, build WS-FRD-ACT-MSG with update error details.",
      "citation": [
        230
      ]
    }
  ],
  "sql_operations": [
    {
      "operation": "INSERT",
      "table": "CARDDEMO.AUTHFRDS",
      "purpose": "Insert comprehensive authorization record as fraud entry with all transaction details, fraud flag, and timestamps.",
      "citation": 142
    },
    {
      "operation": "UPDATE",
      "table": "CARDDEMO.AUTHFRDS",
      "purpose": "Update fraud flag and report date on existing record matching CARD_NUM and AUTH_TS.",
      "citation": 223
    }
  ],
  "cics_operations": [
    {
      "command": "ASKTIME",
      "resource": "ABSTIME(WS-ABS-TIME)",
      "purpose": "Retrieve current absolute time for timestamp processing.",
      "citation": 91
    },
    {
      "command": "FORMATTIME",
      "resource": "ABSTIME(WS-ABS-TIME)",
      "purpose": "Format current absolute time into MMDDYY date for fraud report date.",
      "citation": 95
    },
    {
      "command": "RETURN",
      "resource": null,
      "purpose": "Return transaction control to CICS with updated COMMAREA.",
      "citation": 218
    }
  ],
  "open_questions": [
    {
      "question": "Exact field definitions in CIPAUDTY copybook?",
      "context": "Fields like PA-AUTH-ORIG-DATE, PA-CARD-NUM used extensively but structure not inline.",
      "suggestion": "Analyze CIPAUDTY source for precise layouts and data types."
    },
    {
      "question": "Role of IMS in header mention?",
      "context": "Header states 'CICS COBOL IMS DB2 Program' but no IMS DL/I calls visible; only DB2 SQL.",
      "suggestion": "Check if IMS database is involved via DB2 or omitted from code."
    }
  ],
  "dead_code": [],
  "flow_diagram": "flowchart TD\n    %% Title: COPAUS2C.cbl\n    FRAUD_UPDATE[\"FRAUD-UPDATE\"]\n    CARDDEMO_AUTHFRDS__ext[(\"CARDDEMO.AUTHFRDS\")]\n    MAIN_PARA[\"MAIN-PARA\"]\n    FRAUD_UPDATE -.->|updates| CARDDEMO_AUTHFRDS__ext\n    MAIN_PARA --> FRAUD_UPDATE\n    MAIN_PARA -.->|writes| CARDDEMO_AUTHFRDS__ext"
}