{
  "header": {
    "program_id": "COPAUS2C",
    "file_name": "cbl/COPAUS2C.cbl",
    "file_type": "COBOL",
    "analyzed_by": "WAR_RIG",
    "analyzed_at": "2026-01-26T02:30:15.483322",
    "iteration_count": 1,
    "final_status": null
  },
  "purpose": {
    "summary": "This CICS COBOL program processes authorization messages to mark them as fraud by inserting a record into the CARDDEMO.AUTHFRDS DB2 table using data from the input COMMAREA. If the INSERT fails due to a duplicate key (SQLCODE -803), it performs an UPDATE on the matching record to set the fraud flag and report date. It formats timestamps and dates from input fields, populates host variables, handles SQL errors by updating status in the COMMAREA, and returns to CICS.",
    "business_context": "CardDemo application - Authorization Module for marking fraudulent authorization messages.",
    "program_type": "ONLINE_CICS",
    "citations": [
      2,
      3,
      5,
      22,
      73,
      141
    ]
  },
  "inputs": [
    {
      "name": "DFHCOMMAREA",
      "io_type": "CICS_COMMAREA",
      "description": "Contains WS-ACCT-ID, WS-CUST-ID, WS-FRAUD-AUTH-RECORD (authorization details like PA-CARD-NUM, PA-AUTH-ORIG-DATE), and WS-FRAUD-STATUS-RECORD (action like 'F' for fraud, status, message)",
      "copybook": "CIPAUDTY",
      "citation": [
        73,
        75,
        78
      ]
    }
  ],
  "outputs": [],
  "called_programs": [],
  "calling_context": {
    "called_by": [],
    "entry_points": [],
    "linkage_section": [
      "WS-ACCT-ID",
      "WS-CUST-ID",
      "WS-FRAUD-AUTH-RECORD",
      "WS-FRAUD-STATUS-RECORD"
    ]
  },
  "business_rules": [
    {
      "rule_id": "BR001",
      "description": "On successful INSERT (SQLCODE=0), set update status to success and message to 'ADD SUCCESS'",
      "logic_summary": "Direct assignment after SQL EXEC",
      "conditions": [
        "SQLCODE = ZERO"
      ],
      "citation": [
        199,
        200,
        201
      ]
    },
    {
      "rule_id": "BR002",
      "description": "On INSERT duplicate key error, perform UPDATE instead of failing",
      "logic_summary": "Invoke FRAUD-UPDATE paragraph",
      "conditions": [
        "SQLCODE = -803"
      ],
      "citation": [
        203,
        204
      ]
    },
    {
      "rule_id": "BR003",
      "description": "On any other SQL error after INSERT or UPDATE, set failed status and construct error message with SQLCODE and SQLSTATE",
      "logic_summary": "STRING operation to build message",
      "conditions": [
        "SQLCODE NOT = ZERO",
        "SQLCODE NOT = -803"
      ],
      "citation": [
        206,
        211,
        236
      ]
    }
  ],
  "data_flow": {
    "reads_from": [
      {
        "source": "DFHCOMMAREA",
        "fields_used": [
          "PA-AUTH-ORIG-DATE",
          "PA-CARD-NUM",
          "PA-AUTH-TYPE",
          "WS-FRD-ACTION",
          "WS-ACCT-ID",
          "WS-CUST-ID"
        ],
        "citation": [
          101,
          103,
          113,
          137,
          138,
          139
        ]
      }
    ],
    "writes_to": [
      {
        "destination": "CARDDEMO.AUTHFRDS",
        "fields_written": [
          "AUTH_FRAUD",
          "FRAUD_RPT_DATE",
          "CARD_NUM",
          "AUTH_TS"
        ],
        "citation": [
          142,
          224
        ]
      }
    ],
    "transforms": [
      {
        "input_field": "PA-AUTH-ORIG-DATE",
        "output_field": "WS-AUTH-TS",
        "transformation_description": "Substring moves to YY, MM, DD, HH, MI, SS, SSS components with literals for separators",
        "citation": [
          103,
          104,
          105,
          108,
          109,
          110,
          111
        ]
      },
      {
        "input_field": "PA-AUTH-TIME-9C",
        "output_field": "WS-AUTH-TIME",
        "transformation_description": "Compute WS-AUTH-TIME = 999999999 - input packed time",
        "citation": [
          107
        ]
      },
      {
        "input_field": "WS-ABS-TIME",
        "output_field": "WS-CUR-DATE",
        "transformation_description": "CICS FORMATTIME to MMDDYY format",
        "citation": [
          95,
          101
        ]
      }
    ]
  },
  "copybooks_used": [
    {
      "copybook_name": "CIPAUDTY",
      "purpose": "Defines WS-FRAUD-AUTH-RECORD structure with PA- prefixed fields for authorization message data (e.g., PA-CARD-NUM, PA-AUTH-TYPE)",
      "location": "LINKAGE",
      "citation": 78
    },
    {
      "copybook_name": "SQLCA",
      "purpose": "SQL communication area for SQLCODE, SQLSTATE, and error handling",
      "location": "WORKING_STORAGE",
      "citation": 66
    },
    {
      "copybook_name": "AUTHFRDS",
      "purpose": "Defines host variables (e.g., CARD-NUM, AUTH-TS) matching AUTHFRDS table columns for INSERT/UPDATE",
      "location": "WORKING_STORAGE",
      "citation": 69
    }
  ],
  "paragraphs": [
    {
      "paragraph_name": "MAIN-PARA",
      "summary": null,
      "purpose": "This is the primary entry point and orchestration paragraph for the entire program flow in this CICS transaction. It first consumes current system time via CICS ASKTIME into WS-ABS-TIME and formats the date into WS-CUR-DATE using FORMATTIME, then moves it to PA-FRAUD-RPT-DATE (though this field is not used in SQL). It reads authorization data from LINKAGE DFHCOMMAREA's WS-FRAUD-AUTH-RECORD (PA- fields) and WS-FRAUD-STATUS-RECORD, transforming dates/times: parsing PA-AUTH-ORIG-DATE into WS-AUTH-TS components, computing relative WS-AUTH-TIME from PA-AUTH-TIME-9C, and moving all fields (card num, auth type, merchant details, etc.) to SQL host variables, plus fraud action to AUTH-FRAUD and acct/cust IDs. It produces an SQL INSERT into CARDDEMO.AUTHFRDS with all details, using TIMESTAMP_FORMAT on AUTH-TS and CURRENT DATE for FRAUD_RPT_DATE. Business logic checks SQLCODE post-INSERT: success sets WS-FRD-UPDT-SUCCESS and 'ADD SUCCESS' message; -803 triggers PERFORM FRAUD-UPDATE; other errors set failed status, move SQLCODE/STATE to WS-, and STRING into WS-FRD-ACT-MSG. No file I/O or other validations beyond SQL. It calls FRAUD-UPDATE conditionally for duplicates. Finally, EXEC CICS RETURN passes updated status back via COMMAREA. Error handling is SQL-centric with no abends.",
      "called_by": [],
      "calls": [
        "FRAUD-UPDATE"
      ],
      "citation": [
        89,
        220
      ],
      "outgoing_calls": [],
      "incoming_calls": [],
      "metadata": null
    },
    {
      "paragraph_name": "FRAUD-UPDATE",
      "summary": null,
      "purpose": "This paragraph serves as error recovery for duplicate key violations during INSERT, updating the existing fraud record. It consumes host variables populated in MAIN-PARA (CARD-NUM, AUTH-TS for WHERE, AUTH-FRAUD and CURRENT DATE for SET). It produces an SQL UPDATE on CARDDEMO.AUTHFRDS to set AUTH_FRAUD and FRAUD_RPT_DATE matching exact CARD_NUM and timestamp. Business logic post-UPDATE checks SQLCODE: if 0, sets WS-FRD-UPDT-SUCCESS and 'UPDT SUCCESS'; else sets failed and STRINGs SQLCODE/STATE into WS-FRD-ACT-MSG. No conditions or validations beyond SQLCODE; assumes matching record exists from prior -803. No error branching or abends; updates LINKAGE status for RETURN. Called exclusively by MAIN-PARA on SQLCODE=-803. No subordinate calls.",
      "called_by": [
        "MAIN-PARA"
      ],
      "calls": [],
      "citation": [
        221,
        244
      ],
      "outgoing_calls": [],
      "incoming_calls": [],
      "metadata": null
    }
  ],
  "error_handling": [
    {
      "condition": "SQLCODE = -803 after INSERT",
      "action": "PERFORM FRAUD-UPDATE to modify existing record",
      "citation": [
        203
      ]
    },
    {
      "condition": "SQLCODE NOT = 0 or -803 after INSERT",
      "action": "SET WS-FRD-UPDT-FAILED TO TRUE, build error message with SQLCODE/SQLSTATE",
      "citation": [
        206
      ]
    },
    {
      "condition": "SQLCODE NOT = 0 after UPDATE",
      "action": "SET WS-FRD-UPDT-FAILED TO TRUE, build error message with SQLCODE/SQLSTATE",
      "citation": [
        234
      ]
    }
  ],
  "sql_operations": [
    {
      "operation": "INSERT",
      "table": "CARDDEMO.AUTHFRDS",
      "purpose": "Insert new authorization fraud record with all input details, fraud flag, and current report date",
      "citation": 142
    },
    {
      "operation": "UPDATE",
      "table": "CARDDEMO.AUTHFRDS",
      "purpose": "Update matching authorization record's fraud flag and report date on duplicate key",
      "citation": 223
    }
  ],
  "cics_operations": [
    {
      "command": "ASKTIME",
      "resource": "ABSTIME(WS-ABS-TIME)",
      "purpose": "Retrieve current absolute time for date formatting",
      "citation": 91
    },
    {
      "command": "FORMATTIME",
      "resource": "ABSTIME(WS-ABS-TIME)",
      "purpose": "Convert absolute time to formatted MMDDYY date in WS-CUR-DATE",
      "citation": 95
    },
    {
      "command": "RETURN",
      "resource": null,
      "purpose": "End transaction, return control to CICS with updated DFHCOMMAREA",
      "citation": 218
    }
  ],
  "open_questions": [
    {
      "question": "Exact field definitions in CIPAUDTY copybook (e.g., PA-AUTH-TIME-9C type)?",
      "context": "Fields like PA-AUTH-TIME-9C referenced but not defined in source",
      "suggestion": "Analyze CIPAUDTY copybook"
    },
    {
      "question": "Purpose of MOVE WS-CUR-DATE TO PA-FRAUD-RPT-DATE at line 101?",
      "context": "Field overwritten in INSERT with CURRENT DATE, not used",
      "suggestion": "Check if legacy or for alternate path"
    },
    {
      "question": "Why header mentions IMS but no IMS commands present?",
      "context": "Header: 'CICS COBOL IMS DB2 Program' but only CICS/DB2",
      "suggestion": "Verify if IMS DB used elsewhere or header error"
    }
  ]
}