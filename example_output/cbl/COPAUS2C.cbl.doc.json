{
  "header": {
    "program_id": "COPAUS2C",
    "file_name": "COPAUS2C.cbl",
    "file_type": "COBOL",
    "analyzed_by": "WAR_RIG",
    "analyzed_at": "2026-02-10T17:18:30.886877",
    "iteration_count": 1,
    "final_status": null
  },
  "purpose": {
    "summary": "This CICS COBOL program, COPAUS2C, marks an authorization message as fraudulent by inserting a record into the CARDDEMO.AUTHFRDS table. If a record already exists, it updates the existing record to mark it as fraudulent.",
    "business_context": "This program is part of the CardDemo application's authorization module and is used to report fraudulent transactions.",
    "program_type": "ONLINE_CICS",
    "citations": [
      2,
      5,
      142,
      223
    ]
  },
  "inputs": [
    {
      "name": "DFHCOMMAREA",
      "io_type": "CICS_COMMAREA",
      "description": "The CICS communication area containing the account ID (WS-ACCT-ID), customer ID (WS-CUST-ID), and the fraud authorization record (WS-FRAUD-AUTH-RECORD) which includes the CIPAUDTY copybook. It also contains the fraud status record (WS-FRAUD-STATUS-RECORD) indicating the action to take (report or remove fraud).",
      "copybook": "CIPAUDTY",
      "citation": [
        74,
        78
      ]
    }
  ],
  "outputs": [
    {
      "name": "CARDDEMO.AUTHFRDS",
      "io_type": "DB2_TABLE",
      "description": "This table stores authorization details and fraud status. The program inserts a new record or updates an existing record with fraud information.",
      "copybook": "AUTHFRDS",
      "citation": [
        142,
        223
      ]
    },
    {
      "name": "WS-FRD-ACT-MSG",
      "io_type": "CICS_COMMAREA",
      "description": "A message indicating the success or failure of the fraud update, returned in the DFHCOMMAREA.",
      "copybook": null,
      "citation": [
        201,
        213,
        232,
        241
      ]
    }
  ],
  "called_programs": [],
  "calling_context": {
    "called_by": [],
    "entry_points": [],
    "linkage_section": [
      "DFHCOMMAREA"
    ]
  },
  "business_rules": [
    {
      "rule_id": "BR001",
      "description": "If a record with the same card number and timestamp already exists in the AUTHFRDS table, update the existing record instead of inserting a new one.",
      "logic_summary": "The program checks the SQLCODE after the initial INSERT. If the SQLCODE is -803 (duplicate key), it performs an UPDATE instead.",
      "conditions": [
        "SQLCODE = -803"
      ],
      "citation": [
        199,
        203,
        204
      ]
    }
  ],
  "data_flow": {
    "reads_from": [
      {
        "source": "DFHCOMMAREA",
        "fields_used": [
          "WS-ACCT-ID",
          "WS-CUST-ID",
          "PA-CARD-NUM",
          "PA-AUTH-ORIG-DATE",
          "PA-AUTH-TIME-9C",
          "PA-AUTH-TYPE",
          "PA-CARD-EXPIRY-DATE",
          "PA-MESSAGE-TYPE",
          "PA-MESSAGE-SOURCE",
          "PA-AUTH-ID-CODE",
          "PA-AUTH-RESP-CODE",
          "PA-AUTH-RESP-REASON",
          "PA-PROCESSING-CODE",
          "PA-TRANSACTION-AMT",
          "PA-APPROVED-AMT",
          "PA-MERCHANT-CATAGORY-CODE",
          "PA-ACQR-COUNTRY-CODE",
          "PA-POS-ENTRY-MODE",
          "PA-MERCHANT-ID",
          "PA-MERCHANT-NAME",
          "PA-MERCHANT-CITY",
          "PA-MERCHANT-STATE",
          "PA-MERCHANT-ZIP",
          "PA-TRANSACTION-ID",
          "PA-MATCH-STATUS",
          "WS-FRD-ACTION"
        ],
        "citation": [
          74,
          103,
          113,
          115,
          116,
          117,
          118,
          119,
          120,
          121,
          122,
          123,
          124,
          125,
          127,
          128,
          129,
          131,
          132,
          133,
          134,
          135,
          136,
          137,
          138,
          139
        ]
      }
    ],
    "writes_to": [
      {
        "destination": "CARDDEMO.AUTHFRDS",
        "fields_written": [
          "CARD_NUM",
          "AUTH_TS",
          "AUTH_TYPE",
          "CARD_EXPIRY_DATE",
          "MESSAGE_TYPE",
          "MESSAGE_SOURCE",
          "AUTH_ID_CODE",
          "AUTH_RESP_CODE",
          "AUTH_RESP_REASON",
          "PROCESSING_CODE",
          "TRANSACTION_AMT",
          "APPROVED_AMT",
          "MERCHANT_CATAGORY_CODE",
          "ACQR_COUNTRY_CODE",
          "POS_ENTRY_MODE",
          "MERCHANT_ID",
          "MERCHANT_NAME",
          "MERCHANT_CITY",
          "MERCHANT_STATE",
          "MERCHANT_ZIP",
          "TRANSACTION_ID",
          "MATCH_STATUS",
          "AUTH_FRAUD",
          "FRAUD_RPT_DATE",
          "ACCT_ID",
          "CUST_ID"
        ],
        "citation": [
          142,
          223
        ]
      },
      {
        "destination": "WS-FRD-ACT-MSG",
        "fields_written": [
          "WS-FRD-ACT-MSG"
        ],
        "citation": [
          201,
          213,
          232,
          241
        ]
      }
    ],
    "transforms": [
      {
        "input_field": "PA-AUTH-ORIG-DATE",
        "output_field": "WS-AUTH-YY, WS-AUTH-MM, WS-AUTH-DD",
        "transformation_description": "Splits the PA-AUTH-ORIG-DATE into year, month, and day components.",
        "citation": [
          103,
          104,
          105
        ]
      },
      {
        "input_field": "PA-AUTH-TIME-9C",
        "output_field": "WS-AUTH-TIME, WS-AUTH-HH, WS-AUTH-MI, WS-AUTH-SS, WS-AUTH-SSS",
        "transformation_description": "Calculates the authorization time and splits it into hours, minutes, seconds, and milliseconds.",
        "citation": [
          107,
          108,
          109,
          110,
          111
        ]
      },
      {
        "input_field": "PA-MERCHANT-NAME",
        "output_field": "MERCHANT-NAME-TEXT",
        "transformation_description": "Moves the merchant name and its length to the corresponding output fields.",
        "citation": [
          130,
          131
        ]
      }
    ]
  },
  "copybooks_used": [
    {
      "copybook_name": "DFHBMSCA",
      "purpose": "BMS copybook (likely not used)",
      "location": "UNKNOWN",
      "citation": 61
    },
    {
      "copybook_name": "SQLCA",
      "purpose": "SQL communication area for DB2 interaction.",
      "location": "WORKING_STORAGE",
      "citation": 66
    },
    {
      "copybook_name": "AUTHFRDS",
      "purpose": "Defines the structure of the AUTHFRDS table.",
      "location": "WORKING_STORAGE",
      "citation": 69
    },
    {
      "copybook_name": "CIPAUDTY",
      "purpose": "Defines the structure of the fraud authorization record.",
      "location": "LINKAGE",
      "citation": 78
    }
  ],
  "paragraphs": [
    {
      "paragraph_name": "MAIN-PARA",
      "summary": null,
      "purpose": "This is the main paragraph of the COPAUS2C program. Its primary purpose is to insert or update a record in the CARDDEMO.AUTHFRDS table to mark a transaction as fraudulent. It begins by obtaining the current date and time using CICS ASKTIME and FORMATTIME commands (lines 91-100), storing the formatted date in WS-CUR-DATE and moving it to PA-FRAUD-RPT-DATE. It then transforms the input authorization date and time from the communication area into usable formats (lines 103-111). The paragraph moves data from the input COMMAREA (DFHCOMMAREA) to corresponding fields required for the SQL INSERT statement (lines 113-139). It then executes an SQL INSERT statement to add a new record to the CARDDEMO.AUTHFRDS table (lines 141-198). If the INSERT is successful (SQLCODE = ZERO), it sets WS-FRD-UPDT-SUCCESS to TRUE and moves 'ADD SUCCESS' to WS-FRD-ACT-MSG. If the INSERT fails with a duplicate key error (SQLCODE = -803), it calls the FRAUD-UPDATE paragraph to update the existing record. If any other SQL error occurs, it sets WS-FRD-UPDT-FAILED to TRUE, moves the SQLCODE and SQLSTATE to working storage, and constructs an error message in WS-FRD-ACT-MSG. Finally, it returns control to CICS using EXEC CICS RETURN (lines 218-219).",
      "called_by": [],
      "calls": [
        "FRAUD-UPDATE"
      ],
      "citation": [
        89,
        220
      ],
      "outgoing_calls": [
        {
          "target": "FRAUD-UPDATE",
          "call_type": "performs",
          "line": 204
        },
        {
          "target": "CARDDEMO.AUTHFRDS",
          "call_type": "writes",
          "line": 141
        }
      ],
      "incoming_calls": [],
      "is_dead_code": false,
      "dead_code_reason": null,
      "metadata": {
        "body_chunks": 2
      }
    },
    {
      "paragraph_name": "FRAUD-UPDATE",
      "summary": null,
      "purpose": "This paragraph is called when the initial INSERT statement in MAIN-PARA fails due to a duplicate key error, indicating that a record with the same card number and timestamp already exists in the CARDDEMO.AUTHFRDS table. Its primary purpose is to update the existing record to mark it as fraudulent. It executes an SQL UPDATE statement (lines 222-229) to set the AUTH_FRAUD and FRAUD_RPT_DATE columns for the matching record. The WHERE clause uses the CARD_NUM and AUTH_TS to identify the correct record. If the UPDATE is successful (SQLCODE = ZERO), it sets WS-FRD-UPDT-SUCCESS to TRUE and moves 'UPDT SUCCESS' to WS-FRD-ACT-MSG. If the UPDATE fails, it sets WS-FRD-UPDT-FAILED to TRUE, moves the SQLCODE and SQLSTATE to working storage, and constructs an error message in WS-FRD-ACT-MSG. The paragraph consumes the same input data as the MAIN-PARA, specifically CARD-NUM and AUTH-TS, to identify the record to be updated. The output of this paragraph is the updated record in the CARDDEMO.AUTHFRDS table and a status message in WS-FRD-ACT-MSG. No other paragraphs or programs are called from this paragraph.",
      "called_by": [
        "MAIN-PARA"
      ],
      "calls": [],
      "citation": [
        221,
        244
      ],
      "outgoing_calls": [
        {
          "target": "CARDDEMO.AUTHFRDS",
          "call_type": "updates",
          "line": 222
        }
      ],
      "incoming_calls": [
        {
          "file": "/home/andras/aws-mainframe-modernization-carddemo/app/app-authorization-ims-db2-mq/cbl/COPAUS2C.cbl",
          "function": "MAIN-PARA",
          "line": 204,
          "call_type": "performs"
        }
      ],
      "is_dead_code": false,
      "dead_code_reason": null,
      "metadata": null
    }
  ],
  "error_handling": [
    {
      "condition": "SQLCODE not equal to ZERO after INSERT",
      "action": "If SQLCODE is -803, PERFORM FRAUD-UPDATE. Otherwise, set WS-FRD-UPDT-FAILED to TRUE and construct an error message in WS-FRD-ACT-MSG.",
      "citation": [
        199,
        203,
        206,
        211
      ]
    },
    {
      "condition": "SQLCODE not equal to ZERO after UPDATE",
      "action": "Set WS-FRD-UPDT-FAILED to TRUE and construct an error message in WS-FRD-ACT-MSG.",
      "citation": [
        230,
        234,
        239
      ]
    }
  ],
  "sql_operations": [
    {
      "operation": "INSERT",
      "table": "CARDDEMO.AUTHFRDS",
      "purpose": "To insert a new record indicating a fraudulent authorization.",
      "citation": 142
    },
    {
      "operation": "UPDATE",
      "table": "CARDDEMO.AUTHFRDS",
      "purpose": "To update an existing record to mark it as fraudulent if a record with the same key already exists.",
      "citation": 223
    }
  ],
  "cics_operations": [
    {
      "command": "ASKTIME",
      "resource": null,
      "purpose": "To get the current absolute time.",
      "citation": 91
    },
    {
      "command": "FORMATTIME",
      "resource": null,
      "purpose": "To format the absolute time into a readable date format.",
      "citation": 95
    },
    {
      "command": "RETURN",
      "resource": null,
      "purpose": "To return control to CICS.",
      "citation": 218
    }
  ],
  "open_questions": [
    {
      "question": "What is the structure of the CIPAUDTY copybook?",
      "context": "The copybook is used in the LINKAGE SECTION but its contents are not available.",
      "suggestion": "Obtain the CIPAUDTY copybook to understand the structure of the fraud authorization record."
    },
    {
      "question": "What is the purpose of the DFHBMSCA copybook?",
      "context": "The copybook is included but not explicitly used in the code. It might be a remnant from a previous version or included for potential future use.",
      "suggestion": "Investigate if the DFHBMSCA copybook is actually needed or if it can be removed."
    }
  ],
  "resolved_questions": [],
  "dead_code": [],
  "call_semantics": [
    {
      "caller": "MAIN-PARA",
      "callee": "FRAUD-UPDATE",
      "inputs": [
        "CARD-NUM",
        "AUTH-TS",
        "AUTH-FRAUD"
      ],
      "outputs": [
        "WS-SQLCODE",
        "WS-SQLSTATE",
        "WS-FRD-ACT-MSG"
      ],
      "purpose": "Updates the AUTH_FRAUD and FRAUD_RPT_DATE fields in the AUTHFRDS table for a specific card number and authorization timestamp when a duplicate key error occurs during insert."
    }
  ],
  "flow_diagram": "flowchart TD\n    %% Title: COPAUS2C.cbl\n    FRAUD_UPDATE[\"FRAUD-UPDATE\"]\n    CARDDEMO_AUTHFRDS__ext[(\"CARDDEMO.AUTHFRDS\")]\n    MAIN_PARA[\"MAIN-PARA\"]\n    FRAUD_UPDATE -.->|updates| CARDDEMO_AUTHFRDS__ext\n    MAIN_PARA --> FRAUD_UPDATE\n    MAIN_PARA -.->|writes| CARDDEMO_AUTHFRDS__ext"
}