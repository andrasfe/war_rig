{
  "header": {
    "program_id": "COPAUS2C",
    "file_name": "COPAUS2C.cbl",
    "file_type": "COBOL",
    "analyzed_by": "WAR_RIG",
    "analyzed_at": "2026-02-09T15:46:49.408007",
    "iteration_count": 1,
    "final_status": null
  },
  "purpose": {
    "summary": "This CICS COBOL program, COPAUS2C, marks authorization messages as fraudulent in the CARDDEMO.AUTHFRDS DB2 table. It receives transaction details via the CICS COMMAREA, formats the data, and inserts a new record or updates an existing one if a duplicate is found.",
    "business_context": "This program is part of a card authorization system and is used to flag potentially fraudulent transactions for review.",
    "program_type": "ONLINE_CICS",
    "citations": [
      2,
      5,
      142
    ]
  },
  "inputs": [
    {
      "name": "DFHCOMMAREA",
      "io_type": "CICS_COMMAREA",
      "description": "Contains transaction details including account ID, customer ID, and fraud authorization record (CIPAUDTY).",
      "copybook": null,
      "citation": [
        74,
        78
      ]
    },
    {
      "name": "CIPAUDTY",
      "io_type": "COPYBOOK",
      "description": "Copybook containing the fraud authorization record details.",
      "copybook": "CIPAUDTY",
      "citation": [
        78
      ]
    }
  ],
  "outputs": [
    {
      "name": "CARDDEMO.AUTHFRDS",
      "io_type": "DB2_TABLE",
      "description": "DB2 table where fraudulent authorization messages are stored.",
      "copybook": "AUTHFRDS",
      "citation": [
        142
      ]
    }
  ],
  "called_programs": [],
  "calling_context": {
    "called_by": [],
    "entry_points": [],
    "linkage_section": [
      "DFHCOMMAREA",
      "WS-ACCT-ID",
      "WS-CUST-ID",
      "WS-FRAUD-AUTH-RECORD",
      "WS-FRAUD-STATUS-RECORD"
    ]
  },
  "business_rules": [
    {
      "rule_id": "BR001",
      "description": "If a record with the same card number and timestamp already exists in the AUTHFRDS table, update the existing record instead of inserting a new one.",
      "logic_summary": "The program attempts to insert a new record. If SQLCODE is -803 (duplicate key), it performs an update.",
      "conditions": [
        "SQLCODE = -803"
      ],
      "citation": [
        199,
        203,
        222
      ]
    }
  ],
  "data_flow": {
    "reads_from": [
      {
        "source": "DFHCOMMAREA",
        "fields_used": [
          "PA-CARD-NUM",
          "PA-AUTH-ORIG-DATE",
          "PA-AUTH-TIME-9C",
          "PA-AUTH-TYPE",
          "PA-CARD-EXPIRY-DATE",
          "PA-MESSAGE-TYPE",
          "PA-MESSAGE-SOURCE",
          "PA-AUTH-ID-CODE",
          "PA-AUTH-RESP-CODE",
          "PA-AUTH-RESP-REASON",
          "PA-PROCESSING-CODE",
          "PA-TRANSACTION-AMT",
          "PA-APPROVED-AMT",
          "PA-MERCHANT-CATAGORY-CODE",
          "PA-ACQR-COUNTRY-CODE",
          "PA-POS-ENTRY-MODE",
          "PA-MERCHANT-ID",
          "PA-MERCHANT-NAME",
          "PA-MERCHANT-CITY",
          "PA-MERCHANT-STATE",
          "PA-MERCHANT-ZIP",
          "PA-TRANSACTION-ID",
          "PA-MATCH-STATUS"
        ],
        "citation": [
          103,
          113,
          115,
          116,
          117,
          118,
          119,
          120,
          121,
          122,
          123,
          124,
          125,
          127,
          128,
          129,
          131,
          132,
          133,
          134,
          135,
          136
        ]
      },
      {
        "source": "WS-VARIABLES",
        "fields_used": [
          "WS-FRD-ACTION",
          "WS-ACCT-ID",
          "WS-CUST-ID"
        ],
        "citation": [
          137,
          138,
          139
        ]
      }
    ],
    "writes_to": [
      {
        "destination": "CARDDEMO.AUTHFRDS",
        "fields_written": [
          "CARD_NUM",
          "AUTH_TS",
          "AUTH_TYPE",
          "CARD_EXPIRY_DATE",
          "MESSAGE_TYPE",
          "MESSAGE_SOURCE",
          "AUTH_ID_CODE",
          "AUTH_RESP_CODE",
          "AUTH_RESP_REASON",
          "PROCESSING_CODE",
          "TRANSACTION_AMT",
          "APPROVED_AMT",
          "MERCHANT_CATAGORY_CODE",
          "ACQR_COUNTRY_CODE",
          "POS_ENTRY_MODE",
          "MERCHANT_ID",
          "MERCHANT_NAME",
          "MERCHANT_CITY",
          "MERCHANT_STATE",
          "MERCHANT_ZIP",
          "TRANSACTION_ID",
          "MATCH_STATUS",
          "AUTH_FRAUD",
          "FRAUD_RPT_DATE",
          "ACCT_ID",
          "CUST_ID"
        ],
        "citation": [
          143,
          144,
          145,
          146,
          147,
          148,
          149,
          150,
          151,
          152,
          153,
          154,
          155,
          156,
          157,
          158,
          159,
          160,
          161,
          162,
          163,
          164,
          165,
          166,
          167,
          168
        ]
      }
    ],
    "transforms": [
      {
        "input_field": "PA-AUTH-ORIG-DATE",
        "output_field": "WS-AUTH-YY, WS-AUTH-MM, WS-AUTH-DD",
        "transformation_description": "Extracts year, month, and day from the original authorization date.",
        "citation": [
          103,
          104,
          105
        ]
      },
      {
        "input_field": "PA-AUTH-TIME-9C",
        "output_field": "WS-AUTH-HH, WS-AUTH-MI, WS-AUTH-SS, WS-AUTH-SSS",
        "transformation_description": "Calculates and extracts hour, minute, second, and milliseconds from the authorization time.",
        "citation": [
          107,
          108,
          109,
          110,
          111
        ]
      },
      {
        "input_field": "PA-MERCHANT-NAME",
        "output_field": "MERCHANT-NAME-LEN",
        "transformation_description": "The length of the merchant name is moved to MERCHANT-NAME-LEN",
        "citation": [
          130
        ]
      },
      {
        "input_field": "PA-MERCHANT-NAME",
        "output_field": "MERCHANT-NAME-TEXT",
        "transformation_description": "The merchant name is moved to MERCHANT-NAME-TEXT",
        "citation": [
          131
        ]
      }
    ]
  },
  "copybooks_used": [
    {
      "copybook_name": "DFHBMSCA",
      "purpose": "BMS copybook (commented out)",
      "location": "WORKING_STORAGE",
      "citation": 61
    },
    {
      "copybook_name": "SQLCA",
      "purpose": "SQL Communications Area for DB2 interaction.",
      "location": "WORKING_STORAGE",
      "citation": 66
    },
    {
      "copybook_name": "AUTHFRDS",
      "purpose": "Defines the structure of the AUTHFRDS table.",
      "location": "WORKING_STORAGE",
      "citation": 69
    },
    {
      "copybook_name": "CIPAUDTY",
      "purpose": "Defines the structure of the fraud authorization record.",
      "location": "LINKAGE",
      "citation": 78
    }
  ],
  "paragraphs": [
    {
      "paragraph_name": "MAIN-PARA",
      "summary": null,
      "purpose": "The MAIN-PARA paragraph is the main control flow of the COPAUS2C program. Its primary purpose is to receive transaction data via the COMMAREA, format the data, and insert or update a record in the CARDDEMO.AUTHFRDS DB2 table to mark a transaction as potentially fraudulent. It first retrieves the current date and time using CICS ASKTIME and FORMATTIME commands and moves the current date to PA-FRAUD-RPT-DATE. It then extracts and formats the authorization date and time from the input COMMAREA. The paragraph moves data from the COMMAREA (PA- prefixed fields) and working storage (WS- prefixed fields) to the corresponding fields required for the DB2 INSERT statement. It then executes the SQL INSERT statement to add a new record to the AUTHFRDS table. If the insert is successful (SQLCODE = 0), it sets WS-FRD-UPDT-SUCCESS to TRUE and moves 'ADD SUCCESS' to WS-FRD-ACT-MSG. If a duplicate record is found (SQLCODE = -803), it calls the FRAUD-UPDATE paragraph to update the existing record. If any other SQL error occurs, it sets WS-FRD-UPDT-FAILED to TRUE, moves the SQLCODE and SQLSTATE to working storage, and constructs an error message in WS-FRD-ACT-MSG. Finally, it returns control to CICS using EXEC CICS RETURN.",
      "called_by": [],
      "calls": [
        "FRAUD-UPDATE"
      ],
      "citation": [
        89,
        220
      ],
      "outgoing_calls": [
        {
          "target": "FRAUD-UPDATE",
          "call_type": "performs",
          "line": 204
        },
        {
          "target": "CARDDEMO.AUTHFRDS",
          "call_type": "writes",
          "line": 141
        }
      ],
      "incoming_calls": [],
      "is_dead_code": false,
      "dead_code_reason": null,
      "metadata": {
        "body_chunks": 2
      }
    },
    {
      "paragraph_name": "FRAUD-UPDATE",
      "summary": null,
      "purpose": "The FRAUD-UPDATE paragraph is called when a duplicate record is found during the initial INSERT operation in MAIN-PARA. Its purpose is to update the existing record in the CARDDEMO.AUTHFRDS table with the fraud indicator and current date. It constructs an SQL UPDATE statement to set the AUTH_FRAUD and FRAUD_RPT_DATE columns for the record matching the CARD_NUM and AUTH_TS from the input COMMAREA. After executing the UPDATE statement, it checks the SQLCODE. If the update is successful (SQLCODE = 0), it sets WS-FRD-UPDT-SUCCESS to TRUE and moves 'UPDT SUCCESS' to WS-FRD-ACT-MSG. If the update fails (SQLCODE is not 0), it sets WS-FRD-UPDT-FAILED to TRUE, moves the SQLCODE and SQLSTATE to working storage, and constructs an error message in WS-FRD-ACT-MSG. This paragraph consumes the CARD_NUM and AUTH_TS from the COMMAREA to identify the record to be updated and writes the AUTH_FRAUD and FRAUD_RPT_DATE to the CARDDEMO.AUTHFRDS table. This paragraph is only called from MAIN-PARA when a duplicate record is found and does not call any other paragraphs.",
      "called_by": [
        "MAIN-PARA"
      ],
      "calls": [],
      "citation": [
        221,
        244
      ],
      "outgoing_calls": [
        {
          "target": "CARDDEMO.AUTHFRDS",
          "call_type": "updates",
          "line": 222
        }
      ],
      "incoming_calls": [
        {
          "file": "/home/andras/aws-mainframe-modernization-carddemo/app/app-authorization-ims-db2-mq/cbl/COPAUS2C.cbl",
          "function": "MAIN-PARA",
          "line": 204,
          "call_type": "performs"
        }
      ],
      "is_dead_code": false,
      "dead_code_reason": null,
      "metadata": null
    }
  ],
  "error_handling": [
    {
      "condition": "SQLCODE = -803 (Duplicate Key)",
      "action": "PERFORM FRAUD-UPDATE to update the existing record.",
      "citation": [
        203,
        204
      ]
    },
    {
      "condition": "SQLCODE not ZERO and not -803",
      "action": "SET WS-FRD-UPDT-FAILED to TRUE, move SQLCODE and SQLSTATE to WS-SQLCODE and WS-SQLSTATE, and build an error message in WS-FRD-ACT-MSG.",
      "citation": [
        206,
        208,
        209,
        211
      ]
    },
    {
      "condition": "SQLCODE not ZERO during UPDATE",
      "action": "SET WS-FRD-UPDT-FAILED to TRUE, move SQLCODE and SQLSTATE to WS-SQLCODE and WS-SQLSTATE, and build an error message in WS-FRD-ACT-MSG.",
      "citation": [
        234,
        236,
        237,
        239
      ]
    }
  ],
  "sql_operations": [
    {
      "operation": "INSERT",
      "table": "CARDDEMO.AUTHFRDS",
      "purpose": "To insert a new record indicating a fraudulent authorization message.",
      "citation": 142
    },
    {
      "operation": "UPDATE",
      "table": "CARDDEMO.AUTHFRDS",
      "purpose": "To update an existing record when a duplicate key is encountered during the insert operation, indicating that the fraud status needs to be updated.",
      "citation": 223
    }
  ],
  "cics_operations": [
    {
      "command": "ASKTIME",
      "resource": null,
      "purpose": "Retrieves the current absolute time.",
      "citation": 91
    },
    {
      "command": "FORMATTIME",
      "resource": null,
      "purpose": "Formats the absolute time into a readable date format.",
      "citation": 95
    },
    {
      "command": "RETURN",
      "resource": null,
      "purpose": "Returns control to CICS.",
      "citation": 218
    }
  ],
  "open_questions": [],
  "resolved_questions": [],
  "dead_code": [],
  "call_semantics": [
    {
      "caller": "MAIN-PARA",
      "callee": "FRAUD-UPDATE",
      "inputs": [
        "CARD-NUM",
        "AUTH-TS",
        "AUTH-FRAUD"
      ],
      "outputs": [
        "WS-FRD-UPDT-SUCCESS",
        "WS-FRD-ACT-MSG",
        "WS-SQLCODE",
        "WS-SQLSTATE"
      ],
      "purpose": "Updates the AUTHFRDS table with fraud action and report date when a duplicate key error occurs during insert."
    }
  ],
  "flow_diagram": "flowchart TD\n    %% Title: COPAUS2C.cbl\n    FRAUD_UPDATE[\"FRAUD-UPDATE\"]\n    CARDDEMO_AUTHFRDS__ext[(\"CARDDEMO.AUTHFRDS\")]\n    MAIN_PARA[\"MAIN-PARA\"]\n    FRAUD_UPDATE -.->|updates| CARDDEMO_AUTHFRDS__ext\n    MAIN_PARA --> FRAUD_UPDATE\n    MAIN_PARA -.->|writes| CARDDEMO_AUTHFRDS__ext"
}