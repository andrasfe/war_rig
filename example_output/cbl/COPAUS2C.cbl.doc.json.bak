{
  "header": {
    "program_id": "COPAUS2C",
    "file_name": "cbl/COPAUS2C.cbl",
    "file_type": "COBOL",
    "analyzed_by": "WAR_RIG",
    "analyzed_at": "2026-01-26T14:21:08.902004",
    "iteration_count": 1,
    "final_status": null
  },
  "purpose": {
    "summary": "This CICS COBOL program processes fraud marking requests for authorization messages in the CardDemo application. It receives authorization details, account ID, customer ID, and fraud action via COMMAREA, formats timestamps, and inserts a new record into the CARDDEMO.AUTHFRDS DB2 table. If a duplicate key error (SQLCODE -803) occurs, it updates the existing record instead; otherwise, it sets success or failure status in the COMMAREA and returns.",
    "business_context": "CardDemo Authorization Module: Marks authorization messages as fraudulent",
    "program_type": "ONLINE_CICS",
    "citations": [
      2,
      3,
      4,
      5,
      22,
      74,
      141
    ]
  },
  "inputs": [
    {
      "name": "DFHCOMMAREA",
      "io_type": "CICS_COMMAREA",
      "description": "Contains WS-ACCT-ID, WS-CUST-ID, WS-FRAUD-AUTH-RECORD (authorization details like PA-AUTH-ORIG-DATE, PA-CARD-NUM, etc.), and WS-FRAUD-STATUS-RECORD (fraud action 'F' or 'R')",
      "copybook": "CIPAUDTY",
      "citation": [
        74,
        75,
        76,
        78,
        80
      ]
    }
  ],
  "outputs": [
    {
      "name": "DFHCOMMAREA",
      "io_type": "CICS_COMMAREA",
      "description": "Updated with WS-FRD-UPDT-SUCCESS/FAILED status and WS-FRD-ACT-MSG (success/error message)",
      "copybook": null,
      "citation": [
        80,
        84,
        85,
        86,
        200,
        206
      ]
    },
    {
      "name": "CARDDEMO.AUTHFRDS",
      "io_type": "DB2_TABLE",
      "description": "Fraud authorization records inserted or updated with details like CARD_NUM, AUTH_TS, AUTH_FRAUD='F', FRAUD_RPT_DATE, ACCT_ID, CUST_ID",
      "copybook": "AUTHFRDS",
      "citation": [
        142,
        222
      ]
    }
  ],
  "called_programs": [],
  "calling_context": {
    "called_by": [],
    "entry_points": [],
    "linkage_section": [
      "DFHCOMMAREA",
      "WS-ACCT-ID",
      "WS-CUST-ID",
      "WS-FRAUD-AUTH-RECORD",
      "WS-FRD-ACTION"
    ]
  },
  "business_rules": [
    {
      "rule_id": "BR001",
      "description": "Insert new fraud authorization record; on duplicate key (SQLCODE -803), update existing record's AUTH_FRAUD and FRAUD_RPT_DATE",
      "logic_summary": "Attempt INSERT; if SQLCODE=0 success, if -803 PERFORM FRAUD-UPDATE, else set failure",
      "conditions": [
        "IF SQLCODE = ZERO",
        "IF SQLCODE = -803"
      ],
      "citation": [
        199,
        203
      ]
    },
    {
      "rule_id": "BR002",
      "description": "Set success status and message on successful INSERT or UPDATE; set failure and SQL error details otherwise",
      "logic_summary": "MOVE 'ADD SUCCESS' or 'UPDT SUCCESS' to WS-FRD-ACT-MSG and SET WS-FRD-UPDT-SUCCESS",
      "conditions": [
        "IF SQLCODE = ZERO"
      ],
      "citation": [
        200,
        231
      ]
    }
  ],
  "data_flow": {
    "reads_from": [
      {
        "source": "DFHCOMMAREA",
        "fields_used": [
          "WS-ACCT-ID",
          "WS-CUST-ID",
          "WS-FRD-ACTION",
          "PA-AUTH-ORIG-DATE",
          "PA-CARD-NUM",
          "PA-AUTH-TIME-9C"
        ],
        "citation": [
          75,
          76,
          80,
          103,
          113
        ]
      }
    ],
    "writes_to": [
      {
        "destination": "CARDDEMO.AUTHFRDS",
        "fields_written": [
          "AUTH_FRAUD",
          "FRAUD_RPT_DATE",
          "ACCT_ID",
          "CUST_ID"
        ],
        "citation": [
          142,
          224
        ]
      },
      {
        "destination": "DFHCOMMAREA",
        "fields_written": [
          "WS-FRD-UPDT-STATUS",
          "WS-FRD-ACT-MSG"
        ],
        "citation": [
          200,
          201
        ]
      }
    ],
    "transforms": [
      {
        "input_field": "PA-AUTH-ORIG-DATE",
        "output_field": "WS-AUTH-TS",
        "transformation_description": "Parses date components into formatted timestamp string YY-MM-DD HH.MI.SSsss",
        "citation": [
          103,
          104,
          105
        ]
      },
      {
        "input_field": "PA-AUTH-TIME-9C",
        "output_field": "WS-AUTH-TIME-AN",
        "transformation_description": "Computes inverted time as 999999999 - PA-AUTH-TIME-9C and moves to numeric/alpha for HH,MI,SS,SSS",
        "citation": [
          107,
          108,
          109
        ]
      },
      {
        "input_field": "PA-MERCHANT-NAME",
        "output_field": "MERCHANT-NAME-LEN",
        "transformation_description": "Computes length of merchant name for variable length handling",
        "citation": [
          130
        ]
      }
    ]
  },
  "copybooks_used": [
    {
      "copybook_name": "CIPAUDTY",
      "purpose": "Defines structure of WS-FRAUD-AUTH-RECORD including PA- authorization fields like PA-AUTH-ORIG-DATE, PA-CARD-NUM",
      "location": "LINKAGE",
      "citation": 78
    },
    {
      "copybook_name": "AUTHFRDS",
      "purpose": "SQL INCLUDE defining host variables for AUTHFRDS table like CARD-NUM, AUTH-TS, AUTH-FRAUD",
      "location": "WORKING_STORAGE",
      "citation": 69
    }
  ],
  "paragraphs": [
    {
      "paragraph_name": "MAIN-PARA",
      "summary": null,
      "purpose": "This is the primary entry point and orchestration paragraph for the entire program flow in this CICS transaction. It begins by executing CICS ASKTIME and FORMATTIME to obtain current absolute time and formatted date, storing in WS-ABS-TIME and WS-CUR-DATE, then moves WS-CUR-DATE to PA-FRAUD-RPT-DATE (line 101). It consumes input from DFHCOMMAREA linkage fields including WS-ACCT-ID, WS-CUST-ID, WS-FRD-ACTION, and WS-FRAUD-AUTH-RECORD (PA- fields like PA-AUTH-ORIG-DATE, PA-CARD-NUM). It transforms and formats the authorization timestamp by parsing PA-AUTH-ORIG-DATE into WS-AUTH-YY/MM/DD and computing inverted time from PA-AUTH-TIME-9C into WS-AUTH-HH/MI/SS/SSS, assembling WS-AUTH-TS (lines 103-111). It then moves numerous PA- fields to host variables defined by AUTHFRDS include (e.g., CARD-NUM, AUTH-TYPE, lines 113-139). The core business logic performs an SQL INSERT into CARDDEMO.AUTHFRDS with formatted data, CURRENT DATE for FRAUD_RPT_DATE, and WS-FRD-ACTION as AUTH_FRAUD (lines 141-198). It checks SQLCODE: if 0, sets success status and message; if -803 (duplicate), performs FRAUD-UPDATE paragraph; else, sets failure with SQLCODE/STATE in message (lines 199-216). No explicit file I/O errors beyond SQL, but SQL errors are captured in WS-SQLCODE/STATE. Finally, it executes CICS RETURN to send updated COMMAREA back (line 218). This paragraph calls FRAUD-UPDATE only on duplicate key to handle upserts.",
      "called_by": [],
      "calls": [
        "FRAUD-UPDATE"
      ],
      "citation": [
        89,
        220
      ],
      "outgoing_calls": [],
      "incoming_calls": [],
      "metadata": null
    },
    {
      "paragraph_name": "FRAUD-UPDATE",
      "summary": null,
      "purpose": "This paragraph handles the update case for existing fraud authorization records when INSERT fails with duplicate key (SQLCODE -803). It is called exclusively from MAIN-PARA at line 204. It consumes host variables populated in MAIN-PARA such as AUTH-FRAUD (from WS-FRD-ACTION), CARD-NUM, AUTH-TS. It produces an SQL UPDATE on CARDDEMO.AUTHFRDS setting AUTH_FRAUD and FRAUD_RPT_DATE = CURRENT DATE, keyed by CARD_NUM and exact AUTH_TS match (lines 223-229). The business logic checks SQLCODE post-update: if 0, sets WS-FRD-UPDT-SUCCESS and 'UPDT SUCCESS' message; else, sets failure and builds error string with WS-SQLCODE/WS-SQLSTATE (lines 230-243). Error handling mirrors MAIN-PARA by capturing SQL errors into COMMAREA message fields. It produces no further calls or outputs beyond the SQL and status updates. Control returns to caller (MAIN-PARA) after completion, leading to CICS RETURN. This implements the upsert pattern for fraud marking to avoid duplicates while allowing status changes.",
      "called_by": [
        "MAIN-PARA"
      ],
      "calls": [],
      "citation": [
        221,
        244
      ],
      "outgoing_calls": [],
      "incoming_calls": [],
      "metadata": null
    }
  ],
  "error_handling": [
    {
      "condition": "SQLCODE NOT = 0 after INSERT",
      "action": "If -803, PERFORM FRAUD-UPDATE; else SET WS-FRD-UPDT-FAILED, build error message with SQLCODE/STATE",
      "citation": [
        199,
        203,
        206
      ]
    },
    {
      "condition": "SQLCODE NOT = 0 after UPDATE",
      "action": "SET WS-FRD-UPDT-FAILED, build error message with SQLCODE/STATE",
      "citation": [
        230,
        234
      ]
    }
  ],
  "sql_operations": [
    {
      "operation": "INSERT",
      "table": "CARDDEMO.AUTHFRDS",
      "purpose": "Insert new fraud-marked authorization record with all details from COMMAREA and formatted timestamp",
      "citation": 142
    },
    {
      "operation": "UPDATE",
      "table": "CARDDEMO.AUTHFRDS",
      "purpose": "Update existing record's AUTH_FRAUD and FRAUD_RPT_DATE on duplicate key match by CARD_NUM and AUTH_TS",
      "citation": 223
    }
  ],
  "cics_operations": [
    {
      "command": "ASKTIME",
      "resource": "ABSTIME",
      "purpose": "Obtain current absolute time for date formatting",
      "citation": 91
    },
    {
      "command": "FORMATTIME",
      "resource": "ABSTIME",
      "purpose": "Format current date into MMDDYY for FRAUD_RPT_DATE",
      "citation": 95
    },
    {
      "command": "RETURN",
      "resource": null,
      "purpose": "Return control to CICS with updated COMMAREA",
      "citation": 218
    }
  ],
  "open_questions": [
    {
      "question": "Exact structure and field definitions of CIPAUDTY copybook",
      "context": "PA- fields like PA-AUTH-ORIG-DATE, PA-CARD-NUM used extensively but definitions not in source",
      "suggestion": "Analyze CIPAUDTY copybook source"
    },
    {
      "question": "Host variable definitions from AUTHFRDS SQL INCLUDE",
      "context": "Fields like CARD-NUM, AUTH-TS referenced but not declared in visible COBOL code",
      "suggestion": "Review SQL INCLUDE AUTHFRDS for structure"
    },
    {
      "question": "IMS usage",
      "context": "Header mentions IMS but no IMS DL/I calls visible",
      "suggestion": "Confirm if IMS DB is used indirectly or header outdated"
    }
  ]
}