{
  "header": {
    "program_id": "COPAUS2C",
    "file_name": "COPAUS2C.cbl",
    "file_type": "COBOL",
    "analyzed_by": "WAR_RIG",
    "analyzed_at": "2026-02-24T17:37:50.673985",
    "iteration_count": 1,
    "final_status": null
  },
  "purpose": {
    "summary": "COPAUS2C is a CICS COBOL program that marks authorization messages as fraudulent by inserting or updating records in the CARDDEMO.AUTHFRDS table. It receives transaction details via the CICS COMMAREA, formats the data, and then performs an SQL INSERT or UPDATE operation.",
    "business_context": "This program is part of an authorization module within the CardDemo application, likely used to flag suspicious transactions for further investigation.",
    "program_type": "ONLINE_CICS",
    "citations": [
      2,
      4,
      5,
      142,
      223
    ]
  },
  "inputs": [
    {
      "name": "DFHCOMMAREA",
      "io_type": "CICS_COMMAREA",
      "description": "CICS COMMAREA containing transaction details, account ID, customer ID, and fraud action.",
      "copybook": "CIPAUDTY",
      "citation": [
        74,
        78
      ]
    },
    {
      "name": "CARDDEMO.AUTHFRDS",
      "io_type": "DB2_TABLE",
      "description": "Authorization fraud details table.",
      "copybook": "AUTHFRDS",
      "citation": [
        142,
        223
      ]
    }
  ],
  "outputs": [
    {
      "name": "CARDDEMO.AUTHFRDS",
      "io_type": "DB2_TABLE",
      "description": "Authorization fraud details table, updated with fraud information.",
      "copybook": null,
      "citation": [
        142,
        223
      ]
    },
    {
      "name": "WS-FRD-ACT-MSG",
      "io_type": "CICS_COMMAREA",
      "description": "Message indicating the success or failure of the fraud update.",
      "copybook": null,
      "citation": [
        201,
        213,
        232,
        241
      ]
    }
  ],
  "called_programs": [],
  "calling_context": {
    "called_by": [],
    "entry_points": [],
    "linkage_section": [
      "DFHCOMMAREA"
    ]
  },
  "business_rules": [
    {
      "rule_id": "BR001",
      "description": "If a record with the same card number and timestamp already exists in the AUTHFRDS table, update the existing record instead of inserting a new one.",
      "logic_summary": "Checks SQLCODE after INSERT. If SQLCODE is -803 (duplicate key), performs an UPDATE.",
      "conditions": [
        "SQLCODE = -803"
      ],
      "citation": [
        199,
        203,
        204
      ]
    }
  ],
  "data_flow": {
    "reads_from": [
      {
        "source": "DFHCOMMAREA",
        "fields_used": [
          "PA-CARD-NUM",
          "PA-AUTH-ORIG-DATE",
          "PA-AUTH-TIME-9C",
          "PA-AUTH-TYPE",
          "PA-CARD-EXPIRY-DATE",
          "PA-MESSAGE-TYPE",
          "PA-MESSAGE-SOURCE",
          "PA-AUTH-ID-CODE",
          "PA-AUTH-RESP-CODE",
          "PA-AUTH-RESP-REASON",
          "PA-PROCESSING-CODE",
          "PA-TRANSACTION-AMT",
          "PA-APPROVED-AMT",
          "PA-MERCHANT-CATAGORY-CODE",
          "PA-ACQR-COUNTRY-CODE",
          "PA-POS-ENTRY-MODE",
          "PA-MERCHANT-ID",
          "PA-MERCHANT-NAME",
          "PA-MERCHANT-CITY",
          "PA-MERCHANT-STATE",
          "PA-MERCHANT-ZIP",
          "PA-TRANSACTION-ID",
          "PA-MATCH-STATUS"
        ],
        "citation": [
          103,
          113,
          115,
          116,
          117,
          118,
          119,
          120,
          121,
          122,
          123,
          124,
          125,
          127,
          128,
          129,
          131,
          132,
          133,
          134,
          135,
          136
        ]
      },
      {
        "source": "WS-FRD-ACTION",
        "fields_used": [
          "WS-FRD-ACTION"
        ],
        "citation": [
          137
        ]
      },
      {
        "source": "WS-ACCT-ID",
        "fields_used": [
          "WS-ACCT-ID"
        ],
        "citation": [
          138
        ]
      },
      {
        "source": "WS-CUST-ID",
        "fields_used": [
          "WS-CUST-ID"
        ],
        "citation": [
          139
        ]
      }
    ],
    "writes_to": [
      {
        "destination": "CARDDEMO.AUTHFRDS",
        "fields_written": [
          "CARD_NUM",
          "AUTH_TS",
          "AUTH_TYPE",
          "CARD_EXPIRY_DATE",
          "MESSAGE_TYPE",
          "MESSAGE_SOURCE",
          "AUTH_ID_CODE",
          "AUTH_RESP_CODE",
          "AUTH_RESP_REASON",
          "PROCESSING_CODE",
          "TRANSACTION_AMT",
          "APPROVED_AMT",
          "MERCHANT_CATAGORY_CODE",
          "ACQR_COUNTRY_CODE",
          "POS_ENTRY_MODE",
          "MERCHANT_ID",
          "MERCHANT_NAME",
          "MERCHANT_CITY",
          "MERCHANT_STATE",
          "MERCHANT_ZIP",
          "TRANSACTION_ID",
          "MATCH_STATUS",
          "AUTH_FRAUD",
          "FRAUD_RPT_DATE",
          "ACCT_ID",
          "CUST_ID"
        ],
        "citation": [
          142,
          223
        ]
      }
    ],
    "transforms": [
      {
        "input_field": "PA-AUTH-ORIG-DATE",
        "output_field": "WS-AUTH-YY, WS-AUTH-MM, WS-AUTH-DD",
        "transformation_description": "Extracts year, month, and day from the PA-AUTH-ORIG-DATE field.",
        "citation": [
          103,
          104,
          105
        ]
      },
      {
        "input_field": "PA-AUTH-TIME-9C",
        "output_field": "WS-AUTH-TIME",
        "transformation_description": "Calculates the authorization time by subtracting PA-AUTH-TIME-9C from 999999999.",
        "citation": [
          107
        ]
      },
      {
        "input_field": "WS-AUTH-TIME-AN",
        "output_field": "WS-AUTH-HH, WS-AUTH-MI, WS-AUTH-SS, WS-AUTH-SSS",
        "transformation_description": "Extracts hours, minutes, seconds, and milliseconds from the WS-AUTH-TIME-AN field.",
        "citation": [
          108,
          109,
          110,
          111
        ]
      },
      {
        "input_field": "PA-MERCHANT-NAME",
        "output_field": "MERCHANT-NAME-TEXT",
        "transformation_description": "Moves the merchant name to the MERCHANT-NAME-TEXT field, and its length to MERCHANT-NAME-LEN.",
        "citation": [
          130,
          131
        ]
      }
    ]
  },
  "copybooks_used": [
    {
      "copybook_name": "DFHBMSCA",
      "purpose": "BMS screen definitions (likely not used in this program)",
      "location": "UNKNOWN",
      "citation": 61
    },
    {
      "copybook_name": "SQLCA",
      "purpose": "SQL Communication Area for DB2 interaction.",
      "location": "WORKING_STORAGE",
      "citation": 66
    },
    {
      "copybook_name": "AUTHFRDS",
      "purpose": "Structure of the AUTHFRDS table.",
      "location": "WORKING_STORAGE",
      "citation": 69
    },
    {
      "copybook_name": "CIPAUDTY",
      "purpose": "Audit record structure.",
      "location": "LINKAGE",
      "citation": 78
    }
  ],
  "paragraphs": [
    {
      "paragraph_name": "MAIN-PARA",
      "summary": null,
      "purpose": "The MAIN-PARA paragraph is the primary control flow for the COPAUS2C program. It begins by retrieving the current date and time using CICS ASKTIME and FORMATTIME commands, storing the current date in WS-CUR-DATE and then moving it to PA-FRAUD-RPT-DATE. It then extracts the year, month, and day from PA-AUTH-ORIG-DATE and stores them in WS-AUTH-YY, WS-AUTH-MM, and WS-AUTH-DD, respectively. The authorization time is computed and formatted into WS-AUTH-TS. Subsequently, data from the COMMAREA (PA-*) and working storage (WS-FRD-ACTION, WS-ACCT-ID, WS-CUST-ID) are moved to corresponding fields for insertion into the CARDDEMO.AUTHFRDS table. An SQL INSERT statement is executed to add a new record to the AUTHFRDS table. If the insertion is successful (SQLCODE = ZERO), WS-FRD-UPDT-SUCCESS is set to TRUE, and a success message is moved to WS-FRD-ACT-MSG. If a duplicate record exists (SQLCODE = -803), the FRAUD-UPDATE paragraph is performed to update the existing record. If any other SQL error occurs, WS-FRD-UPDT-FAILED is set to TRUE, the SQLCODE and SQLSTATE are moved to WS-SQLCODE and WS-SQLSTATE, respectively, and an error message is constructed and moved to WS-FRD-ACT-MSG. Finally, the program returns to the calling CICS program using EXEC CICS RETURN.",
      "called_by": [],
      "calls": [
        "FRAUD-UPDATE"
      ],
      "citation": [
        89,
        220
      ],
      "outgoing_calls": [
        {
          "target": "FRAUD-UPDATE",
          "call_type": "performs",
          "line": 204
        },
        {
          "target": "CARDDEMO.AUTHFRDS",
          "call_type": "writes",
          "line": 141
        }
      ],
      "incoming_calls": [],
      "is_dead_code": false,
      "dead_code_reason": null,
      "metadata": {
        "body_chunks": 2
      }
    },
    {
      "paragraph_name": "FRAUD-UPDATE",
      "summary": null,
      "purpose": "The FRAUD-UPDATE paragraph is executed when a duplicate record is found during the initial INSERT operation in MAIN-PARA. Its primary purpose is to update the existing record in the CARDDEMO.AUTHFRDS table with the fraud information. It constructs an SQL UPDATE statement to set the AUTH_FRAUD and FRAUD_RPT_DATE fields for the record matching the CARD_NUM and AUTH_TS from the input COMMAREA. If the update is successful (SQLCODE = ZERO), WS-FRD-UPDT-SUCCESS is set to TRUE, and a success message is moved to WS-FRD-ACT-MSG. If the update fails (SQLCODE is not ZERO), WS-FRD-UPDT-FAILED is set to TRUE, the SQLCODE and SQLSTATE are moved to WS-SQLCODE and WS-SQLSTATE, respectively, and an error message is constructed and moved to WS-FRD-ACT-MSG. This paragraph does not directly consume any input files or data other than the variables set in MAIN-PARA. It updates the CARDDEMO.AUTHFRDS table. The paragraph does not call any other paragraphs or programs. It handles SQL errors by setting flags and constructing error messages.",
      "called_by": [
        "MAIN-PARA"
      ],
      "calls": [],
      "citation": [
        221,
        244
      ],
      "outgoing_calls": [
        {
          "target": "CARDDEMO.AUTHFRDS",
          "call_type": "updates",
          "line": 222
        }
      ],
      "incoming_calls": [
        {
          "file": "/home/andras/aws-mainframe-modernization-carddemo/app/app-authorization-ims-db2-mq/cbl/COPAUS2C.cbl",
          "function": "MAIN-PARA",
          "line": 204,
          "call_type": "performs"
        }
      ],
      "is_dead_code": false,
      "dead_code_reason": null,
      "metadata": null
    }
  ],
  "error_handling": [
    {
      "condition": "SQLCODE not ZERO after INSERT",
      "action": "Check if duplicate record (-803) or other error. If duplicate, perform FRAUD-UPDATE. Otherwise, set error flag and construct error message.",
      "citation": [
        199,
        203,
        206,
        211
      ]
    },
    {
      "condition": "SQLCODE not ZERO after UPDATE",
      "action": "Set error flag and construct error message.",
      "citation": [
        230,
        234,
        239
      ]
    }
  ],
  "sql_operations": [
    {
      "operation": "INSERT",
      "table": "CARDDEMO.AUTHFRDS",
      "purpose": "Insert a new record into the AUTHFRDS table to mark a transaction as fraudulent.",
      "citation": 142
    },
    {
      "operation": "UPDATE",
      "table": "CARDDEMO.AUTHFRDS",
      "purpose": "Update an existing record in the AUTHFRDS table to mark a transaction as fraudulent if a duplicate record is found during insertion.",
      "citation": 223
    }
  ],
  "cics_operations": [
    {
      "command": "ASKTIME",
      "resource": null,
      "purpose": "Retrieve the current absolute time.",
      "citation": 91
    },
    {
      "command": "FORMATTIME",
      "resource": null,
      "purpose": "Format the absolute time into a readable date format.",
      "citation": 95
    },
    {
      "command": "RETURN",
      "resource": null,
      "purpose": "Return control to the calling CICS program.",
      "citation": 218
    }
  ],
  "open_questions": [
    {
      "question": "What is the structure of the CIPAUDTY copybook?",
      "context": "The CIPAUDTY copybook is used in the LINKAGE SECTION, but its contents are not available in the provided code. Knowing the structure is important to know what data is being passed into the program.",
      "suggestion": "Examine the CIPAUDTY copybook to determine the structure of the audit record."
    }
  ],
  "resolved_questions": [],
  "dead_code": [],
  "call_semantics": [
    {
      "caller": "MAIN-PARA",
      "callee": "FRAUD-UPDATE",
      "inputs": [
        "CARD-NUM",
        "AUTH-TS",
        "AUTH-FRAUD"
      ],
      "outputs": [
        "WS-SQLCODE",
        "WS-SQLSTATE",
        "WS-FRD-ACT-MSG"
      ],
      "purpose": "Updates the AUTH_FRAUD and FRAUD_RPT_DATE fields in the AUTHFRDS table for a specific card number and authorization timestamp when a duplicate key error occurs during insert."
    }
  ],
  "flow_diagram": "flowchart TD\n    %% Title: COPAUS2C.cbl\n    FRAUD_UPDATE[\"FRAUD-UPDATE\"]\n    CARDDEMO_AUTHFRDS__ext[(\"CARDDEMO.AUTHFRDS\")]\n    MAIN_PARA[\"MAIN-PARA\"]\n    FRAUD_UPDATE -.->|updates| CARDDEMO_AUTHFRDS__ext\n    MAIN_PARA --> FRAUD_UPDATE\n    MAIN_PARA -.->|writes| CARDDEMO_AUTHFRDS__ext"
}