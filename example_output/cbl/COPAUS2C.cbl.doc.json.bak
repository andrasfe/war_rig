{
  "header": {
    "program_id": "COPAUS2C",
    "file_name": "COPAUS2C.cbl",
    "file_type": "COBOL",
    "analyzed_by": "WAR_RIG",
    "analyzed_at": "2026-01-28T14:54:08.127541",
    "iteration_count": 1,
    "final_status": null
  },
  "purpose": {
    "summary": "The COPAUS2C program is a CICS COBOL program that marks an authorization message as fraudulent by inserting or updating a record in the CARDDEMO.AUTHFRDS table. It receives transaction details via the CICS COMMAREA and uses this data to populate the AUTHFRDS table with information about the potentially fraudulent transaction.",
    "business_context": "This program is part of an authorization module within the CardDemo application, likely used to flag suspicious transactions for further investigation and prevent future fraudulent activities. ",
    "program_type": "ONLINE_CICS",
    "citations": [
      2,
      4,
      5,
      141
    ]
  },
  "inputs": [
    {
      "name": "DFHCOMMAREA",
      "io_type": "CICS_COMMAREA",
      "description": "Contains transaction details including account ID (WS-ACCT-ID), customer ID (WS-CUST-ID), and fraud report data (WS-FRAUD-AUTH-RECORD) based on CIPAUDTY copybook, and fraud status record (WS-FRAUD-STATUS-RECORD).",
      "copybook": "CIPAUDTY",
      "citation": [
        74,
        78
      ]
    }
  ],
  "outputs": [],
  "called_programs": [],
  "calling_context": {
    "called_by": [],
    "entry_points": [],
    "linkage_section": [
      "DFHCOMMAREA"
    ]
  },
  "business_rules": [
    {
      "rule_id": "BR001",
      "description": "If a record with the same CARD_NUM and AUTH_TS already exists in the AUTHFRDS table, update the AUTH_FRAUD and FRAUD_RPT_DATE columns. Otherwise, insert a new record.",
      "logic_summary": "The program first attempts to insert a new record. If the insert fails due to a duplicate key (SQLCODE = -803), it updates the existing record.",
      "conditions": [
        "SQLCODE = ZERO (Insert successful)",
        "SQLCODE = -803 (Duplicate key, update required)"
      ],
      "citation": [
        199,
        203,
        222
      ]
    }
  ],
  "data_flow": {
    "reads_from": [
      {
        "source": "DFHCOMMAREA",
        "fields_used": [
          "PA-CARD-NUM",
          "PA-AUTH-ORIG-DATE",
          "PA-AUTH-TIME-9C",
          "PA-AUTH-TYPE",
          "PA-CARD-EXPIRY-DATE",
          "PA-MESSAGE-TYPE",
          "PA-MESSAGE-SOURCE",
          "PA-AUTH-ID-CODE",
          "PA-AUTH-RESP-CODE",
          "PA-AUTH-RESP-REASON",
          "PA-PROCESSING-CODE",
          "PA-TRANSACTION-AMT",
          "PA-APPROVED-AMT",
          "PA-MERCHANT-CATAGORY-CODE",
          "PA-ACQR-COUNTRY-CODE",
          "PA-POS-ENTRY-MODE",
          "PA-MERCHANT-ID",
          "PA-MERCHANT-NAME",
          "PA-MERCHANT-CITY",
          "PA-MERCHANT-STATE",
          "PA-MERCHANT-ZIP",
          "PA-TRANSACTION-ID",
          "PA-MATCH-STATUS"
        ],
        "citation": [
          103,
          107,
          113,
          115,
          116,
          117,
          118,
          119,
          120,
          121,
          122,
          123,
          124,
          125,
          127,
          128,
          129,
          131,
          132,
          133,
          134,
          135,
          136
        ]
      }
    ],
    "writes_to": [
      {
        "destination": "CARDDEMO.AUTHFRDS",
        "fields_written": [
          "CARD_NUM",
          "AUTH_TS",
          "AUTH_TYPE",
          "CARD_EXPIRY_DATE",
          "MESSAGE_TYPE",
          "MESSAGE_SOURCE",
          "AUTH_ID_CODE",
          "AUTH_RESP_CODE",
          "AUTH_RESP_REASON",
          "PROCESSING_CODE",
          "TRANSACTION_AMT",
          "APPROVED_AMT",
          "MERCHANT_CATAGORY_CODE",
          "ACQR_COUNTRY_CODE",
          "POS_ENTRY_MODE",
          "MERCHANT_ID",
          "MERCHANT_NAME",
          "MERCHANT_CITY",
          "MERCHANT_STATE",
          "MERCHANT_ZIP",
          "TRANSACTION_ID",
          "MATCH_STATUS",
          "AUTH_FRAUD",
          "FRAUD_RPT_DATE",
          "ACCT_ID",
          "CUST_ID"
        ],
        "citation": [
          142,
          223
        ]
      }
    ],
    "transforms": [
      {
        "input_field": "PA-AUTH-ORIG-DATE",
        "output_field": "WS-AUTH-TS (parts)",
        "transformation_description": "Extracts year, month, and day from PA-AUTH-ORIG-DATE and moves them to WS-AUTH-YY, WS-AUTH-MM, and WS-AUTH-DD respectively.",
        "citation": [
          103,
          104,
          105
        ]
      },
      {
        "input_field": "PA-AUTH-TIME-9C",
        "output_field": "WS-AUTH-TIME",
        "transformation_description": "Calculates WS-AUTH-TIME by subtracting PA-AUTH-TIME-9C from 999999999.",
        "citation": [
          107
        ]
      },
      {
        "input_field": "WS-AUTH-TIME-AN",
        "output_field": "WS-AUTH-TS (parts)",
        "transformation_description": "Extracts hour, minute, second, and milliseconds from WS-AUTH-TIME-AN and moves them to WS-AUTH-HH, WS-AUTH-MI, WS-AUTH-SS and WS-AUTH-SSS respectively.",
        "citation": [
          108,
          109,
          110,
          111
        ]
      },
      {
        "input_field": "PA-MERCHANT-NAME",
        "output_field": "MERCHANT-NAME-TEXT",
        "transformation_description": "Moves PA-MERCHANT-NAME to MERCHANT-NAME-TEXT after setting MERCHANT-NAME-LEN to the length of PA-MERCHANT-NAME.",
        "citation": [
          130,
          131
        ]
      }
    ]
  },
  "copybooks_used": [
    {
      "copybook_name": "DFHBMSCA",
      "purpose": "Defines BMS control blocks (commented out)",
      "location": "WORKING_STORAGE",
      "citation": 61
    },
    {
      "copybook_name": "SQLCA",
      "purpose": "SQL Communication Area for DB2 interaction",
      "location": "WORKING_STORAGE",
      "citation": 66
    },
    {
      "copybook_name": "AUTHFRDS",
      "purpose": "Defines the structure of the AUTHFRDS table",
      "location": "WORKING_STORAGE",
      "citation": 69
    },
    {
      "copybook_name": "CIPAUDTY",
      "purpose": "Defines the structure of the fraud report data",
      "location": "LINKAGE",
      "citation": 78
    }
  ],
  "paragraphs": [
    {
      "paragraph_name": "MAIN-PARA",
      "summary": null,
      "purpose": "The MAIN-PARA paragraph is the primary control flow for the COPAUS2C program. It begins by retrieving the current date and time using CICS ASKTIME and FORMATTIME commands and storing the current date in WS-CUR-DATE, which is then moved to PA-FRAUD-RPT-DATE. The paragraph then extracts date and time components from the input COMMAREA (PA-AUTH-ORIG-DATE and PA-AUTH-TIME-9C) and transforms them into a timestamp format suitable for insertion into the AUTHFRDS table. It moves data from the COMMAREA into corresponding fields defined in the AUTHFRDS copybook. The paragraph then executes an SQL INSERT statement to add a new record to the CARDDEMO.AUTHFRDS table with the provided transaction details, marking it as potentially fraudulent. If the insert fails due to a duplicate key, the FRAUD-UPDATE paragraph is performed to update the existing record. Finally, the program returns control to CICS.",
      "called_by": [],
      "calls": [
        "FRAUD-UPDATE"
      ],
      "citation": [
        89,
        220
      ],
      "outgoing_calls": [
        {
          "target": "FRAUD-UPDATE",
          "call_type": "performs",
          "line": 204
        },
        {
          "target": "CARDDEMO.AUTHFRDS",
          "call_type": "writes",
          "line": 141
        }
      ],
      "incoming_calls": [],
      "is_dead_code": false,
      "dead_code_reason": null,
      "metadata": {
        "body_chunks": 2
      }
    },
    {
      "paragraph_name": "FRAUD-UPDATE",
      "summary": null,
      "purpose": "The FRAUD-UPDATE paragraph is executed when the initial INSERT statement in MAIN-PARA fails due to a duplicate key violation, indicating that a record with the same CARD_NUM and AUTH_TS already exists in the CARDDEMO.AUTHFRDS table. This paragraph constructs an SQL UPDATE statement to modify the existing record, setting the AUTH_FRAUD column to the value of WS-FRD-ACTION and updating the FRAUD_RPT_DATE to the current date. The WHERE clause ensures that only the record matching the CARD_NUM and AUTH_TS from the input COMMAREA is updated. After the update, the paragraph checks the SQLCODE to determine if the update was successful. If SQLCODE is ZERO, WS-FRD-UPDT-SUCCESS is set to TRUE, and a success message is moved to WS-FRD-ACT-MSG. Otherwise, WS-FRD-UPDT-FAILED is set to TRUE, and an error message containing the SQLCODE and SQLSTATE is constructed and moved to WS-FRD-ACT-MSG. This paragraph does not call any other paragraphs or programs.",
      "called_by": [
        "MAIN-PARA"
      ],
      "calls": [],
      "citation": [
        221,
        244
      ],
      "outgoing_calls": [
        {
          "target": "CARDDEMO.AUTHFRDS",
          "call_type": "updates",
          "line": 222
        }
      ],
      "incoming_calls": [
        {
          "file": "/home/andras/aws-mainframe-modernization-carddemo/app/app-authorization-ims-db2-mq/cbl/COPAUS2C.cbl",
          "function": "MAIN-PARA",
          "line": 204,
          "call_type": "performs"
        }
      ],
      "is_dead_code": false,
      "dead_code_reason": null,
      "metadata": null
    }
  ],
  "error_handling": [
    {
      "condition": "SQLCODE not equal to ZERO after INSERT",
      "action": "If SQLCODE is -803, perform FRAUD-UPDATE. Otherwise, set WS-FRD-UPDT-FAILED to TRUE and construct an error message with SQLCODE and SQLSTATE.",
      "citation": [
        199,
        203,
        206,
        211
      ]
    },
    {
      "condition": "SQLCODE not equal to ZERO after UPDATE",
      "action": "Set WS-FRD-UPDT-FAILED to TRUE and construct an error message with SQLCODE and SQLSTATE.",
      "citation": [
        230,
        234,
        239
      ]
    }
  ],
  "sql_operations": [
    {
      "operation": "INSERT",
      "table": "CARDDEMO.AUTHFRDS",
      "purpose": "To add a new record to the AUTHFRDS table, marking the authorization message as potentially fraudulent.",
      "citation": 141
    },
    {
      "operation": "UPDATE",
      "table": "CARDDEMO.AUTHFRDS",
      "purpose": "To update an existing record in the AUTHFRDS table when a duplicate key is encountered during the insert operation, indicating that the record already exists.",
      "citation": 223
    }
  ],
  "cics_operations": [
    {
      "command": "ASKTIME",
      "resource": null,
      "purpose": "Retrieves the current absolute time for timestamping.",
      "citation": 91
    },
    {
      "command": "FORMATTIME",
      "resource": null,
      "purpose": "Formats the absolute time into a readable date format.",
      "citation": 95
    },
    {
      "command": "RETURN",
      "resource": null,
      "purpose": "Returns control to CICS.",
      "citation": 218
    }
  ],
  "open_questions": [
    {
      "question": "What is the structure of the CIPAUDTY copybook?",
      "context": "The copybook is used to define WS-FRAUD-AUTH-RECORD, but its contents are not available in the provided code.",
      "suggestion": "Examine the CIPAUDTY copybook to understand the structure of the fraud report data."
    },
    {
      "question": "What are the valid values for WS-FRD-ACTION?",
      "context": "The code defines WS-REPORT-FRAUD and WS-REMOVE-FRAUD, but the exact meaning and usage of these values are unclear without further context.",
      "suggestion": "Review the application's documentation or related code to understand the purpose of the WS-FRD-ACTION field."
    }
  ],
  "dead_code": [],
  "flow_diagram": "flowchart TD\n    %% Title: COPAUS2C.cbl\n    FRAUD_UPDATE[\"FRAUD-UPDATE\"]\n    CARDDEMO_AUTHFRDS__ext[(\"CARDDEMO.AUTHFRDS\")]\n    MAIN_PARA[\"MAIN-PARA\"]\n    FRAUD_UPDATE -.->|updates| CARDDEMO_AUTHFRDS__ext\n    MAIN_PARA --> FRAUD_UPDATE\n    MAIN_PARA -.->|writes| CARDDEMO_AUTHFRDS__ext"
}