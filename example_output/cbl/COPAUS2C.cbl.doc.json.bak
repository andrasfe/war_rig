{
  "header": {
    "program_id": "COPAUS2C",
    "file_name": "cbl/COPAUS2C.cbl",
    "file_type": "COBOL",
    "analyzed_by": "WAR_RIG",
    "analyzed_at": "2026-02-25T15:20:46.974030",
    "iteration_count": 1,
    "final_status": null
  },
  "purpose": {
    "summary": "COPAUS2C is a CICS online program that processes authorization fraud data by formatting the current date and time, parsing authorization timestamps, moving input authorization details from the linkage section to a structured format, and inserting them into the CARDDEMO.AUTHFRDS DB2 table. If the insert fails due to a duplicate key (SQLCODE -803), it performs an update on the same table instead. Upon success or handling errors, it returns control to CICS.",
    "business_context": "Supports fraud logging and updating for card authorization transactions in a payment processing system.",
    "program_type": "ONLINE_CICS",
    "citations": [
      89,
      221
    ]
  },
  "inputs": [
    {
      "name": "PA-RECORD",
      "io_type": "CICS_COMMAREA",
      "description": "Input authorization data including fraud report date, auth orig date, card number, auth time, auth type, card expiry, message type/source, auth codes, amounts, merchant details, transaction ID, and match status",
      "copybook": null,
      "citation": [
        89,
        107
      ]
    }
  ],
  "outputs": [
    {
      "name": "CARDDEMO.AUTHFRDS",
      "io_type": "DB2_TABLE",
      "description": "Fraud authorization details table storing card num, auth timestamp components, type, expiry, message info, auth responses, transaction details, merchant info, acct/cust IDs, and fraud action",
      "copybook": null,
      "citation": [
        199,
        221
      ]
    }
  ],
  "called_programs": [],
  "calling_context": {
    "called_by": [],
    "entry_points": [],
    "linkage_section": [
      "PA-FRAUD-RPT-DATE",
      "PA-AUTH-ORIG-DATE",
      "PA-CARD-NUM",
      "PA-AUTH-TIME",
      "PA-AUTH-TYPE",
      "PA-CARD-EXPIRY-DATE",
      "PA-MESSAGE-TYPE",
      "PA-MESSAGE-SOURCE",
      "PA-AUTH-ID-CODE",
      "PA-AUTH-RESP-CODE",
      "PA-AUTH-RESP-REASON",
      "PA-PROCESSING-CODE",
      "PA-TRANSACTION-AMT",
      "PA-APPROVED-AMT",
      "PA-MERCHANT-CATAGORY-CODE",
      "PA-ACQR-COUNTRY-CODE",
      "PA-POS-ENTRY-MODE",
      "PA-MERCHANT-ID",
      "PA-MERCHANT-NAME",
      "PA-MERCHANT-CITY",
      "PA-MERCHANT-STATE",
      "PA-MERCHANT-ZIP",
      "PA-TRANSACTION-ID",
      "PA-MATCH-STATUS"
    ]
  },
  "business_rules": [
    {
      "rule_id": "BR001",
      "description": "On successful INSERT (SQLCODE=0), set success flag and message; on duplicate key (SQLCODE=-803), perform UPDATE instead; on other errors, set failure flag and build error message",
      "logic_summary": "Nested IF on SQLCODE after INSERT, with PERFORM FRAUD-UPDATE on -803",
      "conditions": [
        "IF SQLCODE = ZERO",
        "IF SQLCODE = -803"
      ],
      "citation": [
        199,
        203
      ]
    }
  ],
  "data_flow": {
    "reads_from": [
      {
        "source": "PA-RECORD",
        "fields_used": [
          "PA-FRAUD-RPT-DATE",
          "PA-AUTH-ORIG-DATE",
          "PA-CARD-NUM",
          "PA-AUTH-TIME",
          "PA-AUTH-TYPE",
          "PA-CARD-EXPIRY-DATE",
          "PA-MESSAGE-TYPE",
          "PA-MESSAGE-SOURCE",
          "PA-AUTH-ID-CODE",
          "PA-AUTH-RESP-CODE",
          "PA-AUTH-RESP-REASON",
          "PA-PROCESSING-CODE",
          "PA-TRANSACTION-AMT",
          "PA-APPROVED-AMT",
          "PA-MERCHANT-CATAGORY-CODE",
          "PA-ACQR-COUNTRY-CODE",
          "PA-POS-ENTRY-MODE",
          "PA-MERCHANT-ID",
          "PA-MERCHANT-NAME",
          "PA-MERCHANT-CITY",
          "PA-MERCHANT-STATE",
          "PA-MERCHANT-ZIP",
          "PA-TRANSACTION-ID",
          "PA-MATCH-STATUS",
          "WS-FRD-ACTION",
          "WS-ACCT-ID",
          "WS-CUST-ID"
        ],
        "citation": [
          89,
          150
        ]
      }
    ],
    "writes_to": [
      {
        "destination": "CARDDEMO.AUTHFRDS",
        "fields_written": [
          "CARD_NUM",
          "AUTH_TS",
          "AUTH_TYPE",
          "CARD_EXPIRY_DATE",
          "MESSAGE_TYPE",
          "MESSAGE_SOURCE",
          "AUTH_ID_CODE",
          "AUTH_RESP_CODE",
          "AUTH_RESP_REASON",
          "PROCESSING_CODE",
          "TRANSACTION_AMT",
          "APPROVED_AMT",
          "MERCHANT_CATAGORY_CODE",
          "ACQR_COUNTRY_CODE",
          "POS_ENTRY_MODE",
          "MERCHANT_ID",
          "MERCHANT_NAME",
          "MERCHANT_CITY",
          "MERCHANT_STATE",
          "MERCHANT_ZIP",
          "TRANSACTION_ID",
          "MATCH_STATUS",
          "AUTH_FRAUD",
          "ACCT_ID",
          "CUST_ID"
        ],
        "citation": [
          199,
          221
        ]
      }
    ],
    "transforms": [
      {
        "input_field": "WS-ABS-TIME",
        "output_field": "WS-CUR-DATE",
        "transformation_description": "Format CICS absolute time to MMDDYY date string using FORMATTIME",
        "citation": [
          89
        ]
      },
      {
        "input_field": "PA-AUTH-ORIG-DATE",
        "output_field": "WS-AUTH-YY, WS-AUTH-MM, WS-AUTH-DD",
        "transformation_description": "Substring extraction: positions 1:2 to YY, 3:2 to MM, 5:2 to DD",
        "citation": [
          89
        ]
      },
      {
        "input_field": "PA-AUTH-TIME-9C",
        "output_field": "WS-AUTH-TIME",
        "transformation_description": "COMPUTE WS-AUTH-TIME = 999999999 - PA-AUTH-TIME-9C to adjust timestamp",
        "citation": [
          107
        ]
      },
      {
        "input_field": "WS-AUTH-TIME-AN",
        "output_field": "WS-AUTH-HH, WS-AUTH-MI, WS-AUTH-SS, WS-AUTH-SSS",
        "transformation_description": "Substring extraction from adjusted time: 1:2 HH, 3:2 MI, 5:2 SS, 7:3 SSS",
        "citation": [
          107
        ]
      },
      {
        "input_field": "PA-MERCHANT-NAME",
        "output_field": "MERCHANT-NAME-LEN",
        "transformation_description": "MOVE LENGTH OF PA-MERCHANT-NAME to MERCHANT-NAME-LEN",
        "citation": [
          150
        ]
      }
    ]
  },
  "copybooks_used": [
    {
      "copybook_name": "SQLCA",
      "purpose": "Defines SQL communication area for SQLCODE and SQLSTATE",
      "location": "WORKING_STORAGE",
      "citation": 23
    }
  ],
  "paragraphs": [
    {
      "paragraph_name": "COPAUS2C",
      "summary": null,
      "purpose": "This is the program entry point paragraph, likely serving as the initial control point in the PROCEDURE DIVISION. It consumes no explicit inputs shown in the AST but sets up the environment by referencing or calling initialization elements. It produces control flow to subsequent paragraphs or external elements like CIPAUDTY for typing or setup, SQLCA for SQL handling, and AUTHFRDS context. No explicit business logic or decisions are detailed in the AST, but it orchestrates the start of fraud authorization processing. Error handling is not visible here, deferred to called paragraphs. It calls CIPAUDTY (possibly for audit typing), SQLCA initialization, and transitions to AUTHFRDS processing context, enabling the main fraud update logic.",
      "called_by": [],
      "calls": [
        "CIPAUDTY",
        "SQLCA",
        "AUTHFRDS"
      ],
      "citation": [
        23,
        23
      ],
      "outgoing_calls": [
        {
          "target": "CIPAUDTY",
          "call_type": "includes",
          "line": 78
        },
        {
          "target": "SQLCA",
          "call_type": "includes",
          "line": 65
        },
        {
          "target": "AUTHFRDS",
          "call_type": "includes",
          "line": 68
        }
      ],
      "incoming_calls": [],
      "is_dead_code": false,
      "dead_code_reason": null,
      "metadata": null
    },
    {
      "paragraph_name": "MAIN-PARA",
      "summary": null,
      "purpose": "This is the primary orchestration paragraph handling the core fraud authorization logging logic in the program flow. It consumes CICS absolute time via ASKTIME and input linkage fields like PA-FRAUD-RPT-DATE, PA-AUTH-ORIG-DATE, PA-CARD-NUM, and numerous other PA- authorization details. It produces formatted WS-CUR-DATE, parsed WS-AUTH-YY/MM/DD/HH/MI/SS/SSS from date/time computations, structured output fields like CARD-NUM and AUTH-TS, and ultimately inserts a record into CARDDEMO.AUTHFRDS. Business logic includes time adjustment via COMPUTE WS-AUTH-TIME = 999999999 - PA-AUTH-TIME-9C (line 107), substring extractions for timestamp components, and numerous MOVE operations to prepare INSERT data; it checks SQLCODE post-INSERT: success sets WS-FRD-UPDT-SUCCESS and 'ADD SUCCESS' message; duplicate (-803) triggers PERFORM FRAUD-UPDATE; other errors set WS-FRD-UPDT-FAILED, capture SQLCODE/SQLSTATE, and STRING error message into WS-FRD-ACT-MSG. Error handling uses sqlcode_check logic (lines 199, 203) for recovery or failure logging without abend. It performs FRAUD-UPDATE for duplicate handling and ends with CICS RETURN to release control.",
      "called_by": [
        "COPAUS2C"
      ],
      "calls": [
        "FRAUD-UPDATE"
      ],
      "citation": [
        89,
        220
      ],
      "outgoing_calls": [
        {
          "target": "FRAUD-UPDATE",
          "call_type": "performs",
          "line": 204
        },
        {
          "target": "CARDDEMO.AUTHFRDS",
          "call_type": "writes",
          "line": 141
        }
      ],
      "incoming_calls": [],
      "is_dead_code": false,
      "dead_code_reason": null,
      "metadata": {
        "body_chunks": 2
      }
    },
    {
      "paragraph_name": "FRAUD-UPDATE",
      "summary": null,
      "purpose": "This paragraph serves as an error recovery routine specifically for duplicate key violations during the initial INSERT, performing an UPDATE on CARDDEMO.AUTHFRDS to set AUTH_FRAUD and other fields from prepared working storage variables. It consumes the pre-moved fields like AUTH-FRAUD (from WS-FRD-ACTION), ACCT-ID, CUST-ID, and prior INSERT targets now used in SET clauses. It produces an updated record in the AUTHFRDS table and status messages in WS-FRD-ACT-MSG. Business logic executes an UPDATE SQL statement targeting the existing record based on CARD_NUM and AUTH_TS, then checks SQLCODE: zero sets WS-FRD-UPDT-SUCCESS and 'UPDT SUCCESS'; non-zero sets WS-FRD-UPDT-FAILED, captures SQLCODE/SQLSTATE, and STRINGs error into WS-FRD-ACT-MSG (sqlcode_check at line 230). Error handling mirrors MAIN-PARA with failure logging but no further recovery or abend shown. No subordinate calls are made; it returns control to the caller (MAIN-PARA post-duplicate detection).",
      "called_by": [
        "MAIN-PARA"
      ],
      "calls": [],
      "citation": [
        221,
        244
      ],
      "outgoing_calls": [
        {
          "target": "CARDDEMO.AUTHFRDS",
          "call_type": "updates",
          "line": 222
        }
      ],
      "incoming_calls": [
        {
          "file": "/Users/andraslferenczi/war_rig/aws-mainframe-modernization-carddemo/app/app-authorization-ims-db2-mq/cbl/COPAUS2C.cbl",
          "function": "MAIN-PARA",
          "line": 204,
          "call_type": "performs"
        },
        {
          "file": "/Users/andraslferenczi/war_rig/aws-mainframe-modernization-carddemo/app/app-authorization-ims-db2-mq/cbl/COPAUS2C.cbl",
          "function": "MAIN-PARA",
          "line": 89,
          "call_type": "performs"
        }
      ],
      "is_dead_code": false,
      "dead_code_reason": null,
      "metadata": null
    }
  ],
  "error_handling": [
    {
      "condition": "SQLCODE NOT = ZERO after INSERT",
      "action": "If SQLCODE = -803, PERFORM FRAUD-UPDATE; else SET WS-FRD-UPDT-FAILED, MOVE SQLCODE/SQLSTATE, STRING error message",
      "citation": [
        199
      ]
    },
    {
      "condition": "SQLCODE NOT = ZERO after UPDATE",
      "action": "SET WS-FRD-UPDT-FAILED, MOVE SQLCODE/SQLSTATE, STRING 'UPDT ERROR DB2: CODE:' WS-SQLCODE ' STATE:' WS-SQLSTATE into WS-FRD-ACT-MSG",
      "citation": [
        230
      ]
    }
  ],
  "sql_operations": [
    {
      "operation": "INSERT",
      "table": "CARDDEMO.AUTHFRDS",
      "purpose": "Log new fraud authorization details from input transaction",
      "citation": 199
    },
    {
      "operation": "UPDATE",
      "table": "CARDDEMO.AUTHFRDS",
      "purpose": "Update existing fraud record with AUTH_FRAUD, ACCT_ID, CUST_ID on duplicate key",
      "citation": 221
    }
  ],
  "cics_operations": [
    {
      "command": "ASKTIME",
      "resource": "WS-ABS-TIME",
      "purpose": "Obtain current absolute time for date formatting",
      "citation": 89
    },
    {
      "command": "FORMATTIME",
      "resource": "WS-ABS-TIME",
      "purpose": "Convert absolute time to MMDDYY format in WS-CUR-DATE",
      "citation": 89
    },
    {
      "command": "RETURN",
      "resource": null,
      "purpose": "Return control to CICS after processing",
      "citation": 220
    }
  ],
  "open_questions": [],
  "resolved_questions": [],
  "dead_code": [],
  "call_semantics": [
    {
      "caller": "MAIN-PARA",
      "callee": "FRAUD-UPDATE",
      "inputs": [],
      "outputs": [],
      "purpose": null
    }
  ],
  "flow_diagram": "flowchart TD\n    %% Title: COPAUS2C.cbl\n    FRAUD_UPDATE[\"FRAUD-UPDATE\"]\n    CARDDEMO_AUTHFRDS__ext[(\"CARDDEMO.AUTHFRDS\")]\n    MAIN_PARA[\"MAIN-PARA\"]\n    FRAUD_UPDATE -.->|updates| CARDDEMO_AUTHFRDS__ext\n    MAIN_PARA --> FRAUD_UPDATE\n    MAIN_PARA -.->|writes| CARDDEMO_AUTHFRDS__ext"
}