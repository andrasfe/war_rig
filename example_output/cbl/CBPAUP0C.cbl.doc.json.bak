{
  "header": {
    "program_id": "CBPAUP0C",
    "file_name": "cbl/CBPAUP0C.cbl",
    "file_type": "COBOL",
    "analyzed_by": "WAR_RIG",
    "analyzed_at": "2026-01-26T15:14:25.753983",
    "iteration_count": 1,
    "final_status": null
  },
  "purpose": {
    "summary": "This IMS batch COBOL program deletes expired pending authorization detail segments (PAUTDTL1) from the PAUT database under PSB PSBPAUTB. For each summary segment (PAUTSUM0), it reads child details, computes age from auth date against configurable expiry days, deletes expired details, adjusts summary counters in working storage memory, and conditionally deletes the summary segment if PA-APPROVED-AUTH-CNT <= 0 (redundantly checked). It takes periodic IMS checkpoints and displays processing statistics upon completion.",
    "business_context": "CardDemo Authorization Module: Automated cleanup of expired pending authorization messages to maintain database hygiene.",
    "program_type": "BATCH",
    "citations": [
      2,
      3,
      4,
      5,
      136,
      140,
      144,
      156
    ]
  },
  "inputs": [
    {
      "name": "PRM-INFO",
      "io_type": "PARAMETER",
      "description": "Command-line parameters from SYSIN containing expiry days (P-EXPIRY-DAYS), checkpoint frequency (P-CHKP-FREQ), checkpoint display frequency (P-CHKP-DIS-FREQ), and debug flag (P-DEBUG-FLAG)",
      "copybook": null,
      "citation": [
        189
      ]
    },
    {
      "name": "PAUTSUM0",
      "io_type": "IMS_SEGMENT",
      "description": "Pending Authorization Summary root segments read sequentially via GN call",
      "copybook": "CIPAUSMY",
      "citation": [
        223
      ]
    },
    {
      "name": "PAUTDTL1",
      "io_type": "IMS_SEGMENT",
      "description": "Pending Authorization Details child segments read via GNP call under current summary",
      "copybook": "CIPAUDTY",
      "citation": [
        255
      ]
    }
  ],
  "outputs": [
    {
      "name": "PAUTDTL1",
      "io_type": "IMS_SEGMENT",
      "description": "Expired Pending Authorization Details segments deleted from IMS database via DLET",
      "copybook": "CIPAUDTY",
      "citation": [
        310
      ]
    },
    {
      "name": "PAUTSUM0",
      "io_type": "IMS_SEGMENT",
      "description": "Pending Authorization Summary segments with no remaining approved auth count deleted from IMS database via DLET",
      "copybook": "CIPAUSMY",
      "citation": [
        335
      ]
    },
    {
      "name": "STATS-REPORT",
      "io_type": "REPORT",
      "description": "Console display of processing statistics including summaries read/deleted and details read/deleted",
      "copybook": null,
      "citation": [
        173
      ]
    },
    {
      "name": "RETURN-CODE",
      "io_type": "RETURN_CODE",
      "description": "Set to 16 upon abend conditions",
      "copybook": null,
      "citation": [
        382
      ]
    }
  ],
  "called_programs": [],
  "calling_context": {
    "called_by": [],
    "entry_points": [],
    "linkage_section": [
      "IO-PCB-MASK",
      "PGM-PCB-MASK"
    ]
  },
  "business_rules": [
    {
      "rule_id": "BR001",
      "description": "Pending authorization detail qualifies for deletion if the number of days since authorization date exceeds or equals the configured expiry days",
      "logic_summary": "Convert packed auth date to YYDDD (99999 - PA-AUTH-DATE-9C), subtract from current YYDDD; if >= WS-EXPIRY-DAYS set flag",
      "conditions": [
        "WS-DAY-DIFF >= WS-EXPIRY-DAYS"
      ],
      "citation": [
        280,
        282,
        284
      ]
    },
    {
      "rule_id": "BR002",
      "description": "On qualified deletion, decrement appropriate summary counters based on response code: approved if '00' else declined",
      "logic_summary": "If PA-AUTH-RESP-CODE = '00' subtract 1 and PA-APPROVED-AMT from approved counters; else subtract from declined counters",
      "conditions": [
        "PA-AUTH-RESP-CODE = '00'"
      ],
      "citation": [
        287,
        291
      ]
    },
    {
      "rule_id": "BR003",
      "description": "Delete summary segment if PA-APPROVED-AUTH-CNT <= 0 (condition checked redundantly against itself)",
      "logic_summary": "After processing all details, check if PA-APPROVED-AUTH-CNT <= 0 AND PA-APPROVED-AUTH-CNT <= 0",
      "conditions": [
        "PA-APPROVED-AUTH-CNT <= 0"
      ],
      "citation": [
        156
      ]
    },
    {
      "rule_id": "BR004",
      "description": "Take IMS checkpoint after every P-CHKP-FREQ summary records processed",
      "logic_summary": "Increment counter per summary; if exceeds param, perform CHKP and reset",
      "conditions": [
        "WS-AUTH-SMRY-PROC-CNT > P-CHKP-FREQ"
      ],
      "citation": [
        160
      ]
    }
  ],
  "data_flow": {
    "reads_from": [
      {
        "source": "PAUTSUM0",
        "fields_used": [
          "PA-ACCT-ID"
        ],
        "citation": [
          233
        ]
      },
      {
        "source": "PAUTDTL1",
        "fields_used": [
          "PA-AUTH-DATE-9C",
          "PA-AUTH-RESP-CODE"
        ],
        "citation": [
          280,
          287
        ]
      }
    ],
    "writes_to": [
      {
        "destination": "PAUTDTL1",
        "fields_written": [
          "(deleted)"
        ],
        "citation": [
          310
        ]
      },
      {
        "destination": "PAUTSUM0",
        "fields_written": [
          "(deleted)"
        ],
        "citation": [
          335
        ]
      },
      {
        "destination": "PA-APPROVED-AUTH-CNT",
        "fields_written": [
          "decremented in memory"
        ],
        "citation": [
          288
        ]
      },
      {
        "destination": "PA-DECLINED-AUTH-CNT",
        "fields_written": [
          "decremented in memory"
        ],
        "citation": [
          291
        ]
      }
    ],
    "transforms": [
      {
        "input_field": "PA-AUTH-DATE-9C",
        "output_field": "WS-AUTH-DATE",
        "transformation_description": "Convert packed century date to YYDDD format: WS-AUTH-DATE = 99999 - PA-AUTH-DATE-9C",
        "citation": [
          280
        ]
      },
      {
        "input_field": "WS-AUTH-DATE",
        "output_field": "WS-DAY-DIFF",
        "transformation_description": "Compute days since auth: WS-DAY-DIFF = CURRENT-YYDDD - WS-AUTH-DATE",
        "citation": [
          282
        ]
      }
    ]
  },
  "copybooks_used": [
    {
      "copybook_name": "CIPAUSMY",
      "purpose": "Defines layout of PENDING-AUTH-SUMMARY (PAUTSUM0) root segment including counters like PA-APPROVED-AUTH-CNT",
      "location": "WORKING_STORAGE",
      "citation": 117
    },
    {
      "copybook_name": "CIPAUDTY",
      "purpose": "Defines layout of PENDING-AUTH-DETAILS (PAUTDTL1) child segment including PA-AUTH-DATE-9C and PA-AUTH-RESP-CODE",
      "location": "WORKING_STORAGE",
      "citation": 121
    }
  ],
  "paragraphs": [
    {
      "paragraph_name": "MAIN-PARA",
      "summary": null,
      "purpose": "This is the primary orchestration paragraph controlling the entire program flow from initialization to termination. It consumes IMS PCB masks from linkage and begins by performing 1000-INITIALIZE to accept current date, read parameters from SYSIN, and set defaults for expiry days, checkpoint frequencies, and debug flag. It then enters an outer loop performing 2000-FIND-NEXT-AUTH-SUMMARY until end-of-DB or error, reading summary segments into PENDING-AUTH-SUMMARY. For each summary, it enters an inner loop with 3000-FIND-NEXT-AUTH-DTL to read child details into PENDING-AUTH-DETAILS until no more. For each detail, it performs 4000-CHECK-IF-EXPIRED to compute age and qualify for delete, adjusting summary counters in memory if expired, and conditionally performs 5000-DELETE-AUTH-DTL. After inner loop, it checks if PA-APPROVED-AUTH-CNT <= 0 (twice) and performs 6000-DELETE-AUTH-SUMMARY if true. Periodically checks WS-AUTH-SMRY-PROC-CNT against P-CHKP-FREQ to perform 9000-TAKE-CHECKPOINT. Upon outer loop exit, takes final checkpoint, displays aggregate statistics (reads/deletes for summary/details), and GOBACKs. Errors from subordinate paragraphs propagate via WS-ERR-FLG or abend calls. No direct validation beyond parameter numeric check; relies on IMS status evaluation in callees.",
      "called_by": [],
      "calls": [
        "1000-INITIALIZE",
        "2000-FIND-NEXT-AUTH-SUMMARY",
        "3000-FIND-NEXT-AUTH-DTL",
        "4000-CHECK-IF-EXPIRED",
        "5000-DELETE-AUTH-DTL",
        "6000-DELETE-AUTH-SUMMARY",
        "9000-TAKE-CHECKPOINT"
      ],
      "citation": [
        136,
        180
      ],
      "outgoing_calls": [],
      "incoming_calls": [],
      "metadata": null
    },
    {
      "paragraph_name": "1000-INITIALIZE",
      "summary": null,
      "purpose": "This initialization paragraph sets up program variables and parameters before main processing. It consumes system date via ACCEPT CURRENT-DATE FROM DATE and CURRENT-YYDDD FROM DAY into working storage. Reads PRM-INFO from SYSIN into parameter area, displays start message, parameters, and date. Validates and sets WS-EXPIRY-DAYS from P-EXPIRY-DAYS if numeric else defaults to 5; sets P-CHKP-FREQ to 5 if invalid; P-CHKP-DIS-FREQ to 10 if invalid; P-DEBUG-FLAG to 'N' if not 'Y'. Produces initialized WS-VARIABLES, PRM-INFO, and console display messages. Implements business logic for parameter defaults and validation. No error handling beyond numeric check; invalid params use defaults without abend. Called only from MAIN-PARA at start.",
      "called_by": [
        "MAIN-PARA"
      ],
      "calls": [],
      "citation": [
        183,
        213
      ],
      "outgoing_calls": [],
      "incoming_calls": [],
      "metadata": null
    },
    {
      "paragraph_name": "2000-FIND-NEXT-AUTH-SUMMARY",
      "summary": null,
      "purpose": "This paragraph retrieves the next Pending Authorization Summary root segment via IMS GN call. It conditionally displays debug read count if DEBUG-ON. Performs EXEC DLI GN on PAUT-PCB-NUM for SEGMENT PAUTSUM0 into PENDING-AUTH-SUMMARY. Evaluates DIBSTAT: if blank, sets NOT-END-OF-AUTHDB, increments WS-NO-SUMRY-READ and WS-AUTH-SMRY-PROC-CNT, moves PA-ACCT-ID to WS-CURR-APP-ID; if 'GB' sets END-OF-AUTHDB; other statuses display error and perform 9999-ABEND. Consumes IMS database via PCB; produces loaded PENDING-AUTH-SUMMARY or EOF flag. Implements decision on IMS status for continue/abend. Error handling abends on unexpected status. Called repeatedly from MAIN-PARA outer loop.",
      "called_by": [
        "MAIN-PARA"
      ],
      "calls": [
        "9999-ABEND"
      ],
      "citation": [
        216,
        244
      ],
      "outgoing_calls": [],
      "incoming_calls": [],
      "metadata": null
    },
    {
      "paragraph_name": "3000-FIND-NEXT-AUTH-DTL",
      "summary": null,
      "purpose": "This paragraph retrieves the next Pending Authorization Details child segment under current summary via IMS GNP call. Conditionally displays debug read count if DEBUG-ON. Performs EXEC DLI GNP on PAUT-PCB-NUM for SEGMENT PAUTDTL1 into PENDING-AUTH-DETAILS. Evaluates DIBSTAT: if blank sets MORE-AUTHS and increments WS-NO-DTL-READ; if 'GE' or 'GB' sets NO-MORE-AUTHS; other displays error with current PA-ACCT-ID and performs 9999-ABEND. Consumes IMS database via PCB under current parent; produces loaded PENDING-AUTH-DETAILS or no-more flag. Handles segment-not-found and end-of-DB as normal termination of inner loop. Error handling abends on unexpected status. Called repeatedly from MAIN-PARA inner loop.",
      "called_by": [
        "MAIN-PARA"
      ],
      "calls": [
        "9999-ABEND"
      ],
      "citation": [
        248,
        274
      ],
      "outgoing_calls": [],
      "incoming_calls": [],
      "metadata": null
    },
    {
      "paragraph_name": "4000-CHECK-IF-EXPIRED",
      "summary": null,
      "purpose": "This paragraph determines if current detail segment is expired and adjusts summary counters if so. Consumes fields from PENDING-AUTH-DETAILS (PA-AUTH-DATE-9C, PA-AUTH-RESP-CODE) and working storage CURRENT-YYDDD/WS-EXPIRY-DAYS; also modifies fields in PENDING-AUTH-SUMMARY counters. Computes WS-AUTH-DATE as 99999 - PA-AUTH-DATE-9C then WS-DAY-DIFF as CURRENT-YYDDD - WS-AUTH-DATE. If WS-DAY-DIFF >= WS-EXPIRY-DAYS sets QUALIFIED-FOR-DELETE and adjusts counters: if PA-AUTH-RESP-CODE='00' decrement/subtract from approved cnt/amt else from declined; else sets NOT-QUALIFIED-FOR-DELETE. Implements core business logic for expiration check and counter maintenance (memory-only). No error handling or validation; assumes valid data. Called from MAIN-PARA for each detail.",
      "called_by": [
        "MAIN-PARA"
      ],
      "calls": [],
      "citation": [
        277,
        300
      ],
      "outgoing_calls": [],
      "incoming_calls": [],
      "metadata": null
    },
    {
      "paragraph_name": "5000-DELETE-AUTH-DTL",
      "summary": null,
      "purpose": "This paragraph deletes the current qualified expired detail segment from IMS. Conditionally displays debug delete message with PA-ACCT-ID if DEBUG-ON. Performs EXEC DLI DLET on PAUT-PCB-NUM for SEGMENT PAUTDTL1 FROM PENDING-AUTH-DETAILS. If DIBSTAT blank, increments WS-NO-DTL-DELETED; else displays error with PA-ACCT-ID and performs 9999-ABEND. Consumes loaded PENDING-AUTH-DETAILS; produces database deletion and updated delete counter. Business logic assumes prior qualification; no re-check. Error handling abends on failed delete. Called conditionally from MAIN-PARA after expiry check.",
      "called_by": [
        "MAIN-PARA"
      ],
      "calls": [
        "9999-ABEND"
      ],
      "citation": [
        303,
        325
      ],
      "outgoing_calls": [],
      "incoming_calls": [],
      "metadata": null
    },
    {
      "paragraph_name": "6000-DELETE-AUTH-SUMMARY",
      "summary": null,
      "purpose": "This paragraph deletes the current summary segment if no remaining details. Conditionally displays debug delete message with PA-ACCT-ID if DEBUG-ON. Performs EXEC DLI DLET on PAUT-PCB-NUM for SEGMENT PAUTSUM0 FROM PENDING-AUTH-SUMMARY. If DIBSTAT blank, increments WS-NO-SUMRY-DELETED; else displays error with PA-ACCT-ID and performs 9999-ABEND. Consumes loaded PENDING-AUTH-SUMMARY; produces database deletion and updated delete counter. Called only after all details processed and condition met in MAIN-PARA. Error handling abends on failed delete.",
      "called_by": [
        "MAIN-PARA"
      ],
      "calls": [
        "9999-ABEND"
      ],
      "citation": [
        328,
        349
      ],
      "outgoing_calls": [],
      "incoming_calls": [],
      "metadata": null
    },
    {
      "paragraph_name": "9000-TAKE-CHECKPOINT",
      "summary": null,
      "purpose": "This paragraph performs an IMS checkpoint to commit changes periodically. Performs EXEC DLI CHKP ID(WK-CHKPT-ID). If DIBSTAT blank, increments WS-NO-CHKP and if >= P-CHKP-DIS-FREQ resets counter and displays success with counts/APP-ID; else displays failure details and performs 9999-ABEND. Consumes checkpoint ID and counters; produces committed DB changes and optional display. Business logic for restartability via checkpoints every configured summaries. Error handling abends on failed CHKP. Called from MAIN-PARA periodically and at end.",
      "called_by": [
        "MAIN-PARA"
      ],
      "calls": [
        "9999-ABEND"
      ],
      "citation": [
        352,
        374
      ],
      "outgoing_calls": [],
      "incoming_calls": [],
      "metadata": null
    },
    {
      "paragraph_name": "9999-ABEND",
      "summary": null,
      "purpose": "This terminal error handler abends the program on IMS failures or other irrecoverable conditions. Displays abend message 'CBPAUP0C ABENDING ...'. Sets RETURN-CODE to 16 and GOBACKs, causing batch job abend. Consumes no inputs; produces non-zero return code for job control. No business logic; purely error termination. Called from multiple paragraphs on IMS status errors. No further error handling.",
      "called_by": [
        "2000-FIND-NEXT-AUTH-SUMMARY",
        "3000-FIND-NEXT-AUTH-DTL",
        "5000-DELETE-AUTH-DTL",
        "6000-DELETE-AUTH-SUMMARY",
        "9000-TAKE-CHECKPOINT"
      ],
      "calls": [],
      "citation": [
        377,
        386
      ],
      "outgoing_calls": [],
      "incoming_calls": [],
      "metadata": null
    }
  ],
  "error_handling": [
    {
      "condition": "IMS GN DIBSTAT OTHER than ' ' or 'GB'",
      "action": "Display error and perform 9999-ABEND",
      "citation": [
        237
      ]
    },
    {
      "condition": "IMS GNP DIBSTAT OTHER than ' ','GE','GB'",
      "action": "Display error and perform 9999-ABEND",
      "citation": [
        267
      ]
    },
    {
      "condition": "IMS DLET (detail) DIBSTAT NOT SPACES",
      "action": "Display error and perform 9999-ABEND",
      "citation": [
        318
      ]
    },
    {
      "condition": "IMS DLET (summary) DIBSTAT NOT SPACES",
      "action": "Display error and perform 9999-ABEND",
      "citation": [
        343
      ]
    },
    {
      "condition": "IMS CHKP DIBSTAT NOT SPACES",
      "action": "Display error and perform 9999-ABEND",
      "citation": [
        366
      ]
    }
  ],
  "sql_operations": [],
  "cics_operations": [],
  "open_questions": [
    {
      "question": "Are summary segment counters (PA-APPROVED-AUTH-CNT etc.) intended to be updated in the database for non-deleted summaries?",
      "context": "Counters modified in memory at lines 288-292 but no IMS REPL call; changes lost unless summary deleted via DLET.",
      "suggestion": "Review program requirements or job logs to confirm if defect; consider adding REPL after detail processing."
    },
    {
      "question": "Is the summary delete condition at line 156 a defect (checks PA-APPROVED-AUTH-CNT <=0 twice)?",
      "context": "Code: PA-APPROVED-AUTH-CNT <= 0 AND PA-APPROVED-AUTH-CNT <= 0; likely meant to check both approved and declined counts.",
      "suggestion": "Cross-reference with copybook CIPAUSMY and requirements for PA-DECLINED-AUTH-CNT."
    }
  ]
}