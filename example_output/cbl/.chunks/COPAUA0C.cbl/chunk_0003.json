{
  "batch_idx": 3,
  "total_batches": 5,
  "template": {
    "header": {
      "program_id": "COPAUA0C",
      "file_name": "cbl/COPAUA0C.cbl",
      "file_type": "COBOL",
      "analyzed_by": "WAR_RIG",
      "analyzed_at": "2026-02-25T15:32:51.010962",
      "iteration_count": 1,
      "final_status": null
    },
    "purpose": {
      "summary": "This code snippet documents the database write phase of COPAUA0C, which updates or inserts pending authorization summary segments in IMS and inserts new authorization detail segments. It accumulates statistics on approved/declined authorizations, timestamps records using CICS time services, and handles IMS DLI operations with error logging. The terminate phase closes the MQ request queue.",
      "business_context": "Credit card authorization processing, persisting response details and summaries to IMS PAUT database for pending auth tracking.",
      "program_type": "ONLINE_CICS",
      "citations": [
        786,
        798,
        854,
        940
      ]
    },
    "inputs": [
      {
        "name": "PAUT-SMRY-SEG",
        "io_type": "IMS_SEGMENT",
        "description": "Pending authorization summary segment existence flags (NFOUND-PAUT-SMRY-SEG, FOUND-PAUT-SMRY-SEG) from prior IMS read",
        "copybook": null,
        "citation": [
          798,
          830
        ]
      },
      {
        "name": "Working Storage and Cross-Reference Data",
        "io_type": "OTHER",
        "description": "Variables including XREF-ACCT-ID, XREF-CUST-ID, ACCT-CREDIT-LIMIT, ACCT-CASH-CREDIT-LIMIT, AUTH-RESP-APPROVED, WS-APPROVED-AMT, PA-RQ-*, PA-RL-* populated from prior processing",
        "copybook": null,
        "citation": [
          802,
          806,
          810,
          854
        ]
      }
    ],
    "outputs": [
      {
        "name": "PAUTSUM0",
        "io_type": "IMS_SEGMENT",
        "description": "Pending authorization summary segment updated via REPL or inserted via ISRT with counts, amounts, balances",
        "copybook": null,
        "citation": [
          830,
          835
        ]
      },
      {
        "name": "PAUTDTL1",
        "io_type": "IMS_SEGMENT",
        "description": "New pending authorization details segment inserted under PAUTSUM0 with transaction details, timestamps, response codes",
        "copybook": null,
        "citation": [
          910
        ]
      }
    ],
    "called_programs": [],
    "calling_context": {
      "called_by": [],
      "entry_points": [],
      "linkage_section": []
    },
    "business_rules": [
      {
        "rule_id": "BR001",
        "description": "If authorization is approved, increment approved count, add approved amount to approved amount and credit balance, zero cash balance",
        "logic_summary": "IF AUTH-RESP-APPROVED ADD 1 TO PA-APPROVED-AUTH-CNT, ADD WS-APPROVED-AMT TO PA-APPROVED-AUTH-AMT and PA-CREDIT-BALANCE, MOVE 0 TO PA-CASH-BALANCE",
        "conditions": [
          "AUTH-RESP-APPROVED"
        ],
        "citation": [
          810,
          815
        ]
      },
      {
        "rule_id": "BR002",
        "description": "If authorization is declined, increment declined count and add transaction amount to declined amount",
        "logic_summary": "ELSE ADD 1 TO PA-DECLINED-AUTH-CNT, ADD PA-TRANSACTION-AMT TO PA-DECLINED-AUTH-AMT",
        "conditions": [
          "NOT AUTH-RESP-APPROVED"
        ],
        "citation": [
          820
        ]
      },
      {
        "rule_id": "BR003",
        "description": "For new summary, initialize and set account/customer IDs from cross-reference",
        "logic_summary": "IF NFOUND-PAUT-SMRY-SEG INITIALIZE PENDING-AUTH-SUMMARY, MOVE XREF-ACCT-ID TO PA-ACCT-ID, MOVE XREF-CUST-ID TO PA-CUST-ID",
        "conditions": [
          "NFOUND-PAUT-SMRY-SEG"
        ],
        "citation": [
          800,
          802
        ]
      },
      {
        "rule_id": "BR004",
        "description": "Set detail match status to pending if approved, else match-auth-declined",
        "logic_summary": "IF AUTH-RESP-APPROVED SET PA-MATCH-PENDING ELSE SET PA-MATCH-AUTH-DECLINED",
        "conditions": [
          "AUTH-RESP-APPROVED"
        ],
        "citation": [
          895
        ]
      }
    ],
    "data_flow": {
      "reads_from": [
        {
          "source": "PAUT-SMRY-SEG flags",
          "fields_used": [
            "NFOUND-PAUT-SMRY-SEG",
            "FOUND-PAUT-SMRY-SEG"
          ],
          "citation": [
            798,
            830
          ]
        },
        {
          "source": "Account data",
          "fields_used": [
            "XREF-ACCT-ID",
            "XREF-CUST-ID",
            "ACCT-CREDIT-LIMIT",
            "ACCT-CASH-CREDIT-LIMIT"
          ],
          "citation": [
            802,
            806
          ]
        },
        {
          "source": "Auth response",
          "fields_used": [
            "AUTH-RESP-APPROVED",
            "WS-APPROVED-AMT",
            "PA-TRANSACTION-AMT",
            "PA-RL-*"
          ],
          "citation": [
            810,
            880
          ]
        }
      ],
      "writes_to": [
        {
          "destination": "PENDING-AUTH-SUMMARY",
          "fields_written": [
            "PA-APPROVED-AUTH-CNT",
            "PA-APPROVED-AUTH-AMT",
            "PA-DECLINED-AUTH-CNT",
            "PA-DECLINED-AUTH-AMT",
            "PA-CREDIT-BALANCE",
            "PA-CASH-BALANCE"
          ],
          "citation": [
            810,
            820
          ]
        },
        {
          "destination": "PENDING-AUTH-DETAILS",
          "fields_written": [
            "PA-AUTH-DATE-9C",
            "PA-AUTH-TIME-9C",
            "PA-* all fields from moves"
          ],
          "citation": [
            860,
            910
          ]
        }
      ],
      "transforms": [
        {
          "input_field": "WS-YYDDD",
          "output_field": "PA-AUTH-DATE-9C",
          "transformation_description": "COMPUTE PA-AUTH-DATE-9C = 99999 - WS-YYDDD",
          "citation": [
            865
          ]
        },
        {
          "input_field": "WS-CUR-TIME-N6, WS-CUR-TIME-MS",
          "output_field": "WS-TIME-WITH-MS",
          "transformation_description": "COMPUTE WS-TIME-WITH-MS = (WS-CUR-TIME-N6 * 1000) + WS-CUR-TIME-MS",
          "citation": [
            870
          ]
        },
        {
          "input_field": "WS-TIME-WITH-MS",
          "output_field": "PA-AUTH-TIME-9C",
          "transformation_description": "COMPUTE PA-AUTH-TIME-9C = 999999999 - WS-TIME-WITH-MS",
          "citation": [
            865
          ]
        }
      ]
    },
    "copybooks_used": [],
    "paragraphs": [
      {
        "paragraph_name": "8000-WRITE-AUTH-TO-DB",
        "summary": null,
        "purpose": "This paragraph orchestrates the writing of authorization data to the IMS PAUT database after processing. It consumes working storage data including cross-reference IDs, account limits, approval status, and amounts from prior paragraphs. It produces calls to update/insert summary and details segments in IMS. The primary role is to ensure both summary statistics and detail records are persisted atomically in sequence. No direct business decisions here; it delegates to subordinates. Error handling is performed in callees via logging. It calls 8400-UPDATE-SUMMARY THRU 8400-EXIT to handle summary accumulation and IMS update/insert, then 8500-INSERT-AUTH THRU 8500-EXIT to insert the detail record with timestamps. Control then exits via 8000-EXIT.",
        "called_by": [],
        "calls": [
          "8400-UPDATE-SUMMARY",
          "8500-INSERT-AUTH"
        ],
        "citation": [
          786,
          793
        ],
        "outgoing_calls": [],
        "incoming_calls": [],
        "is_dead_code": false,
        "dead_code_reason": null,
        "metadata": null
      },
      {
        "paragraph_name": "8000-EXIT",
        "summary": null,
        "purpose": "This paragraph serves as the dedicated exit point for the 8000-WRITE-AUTH-TO-DB procedure. It consumes no inputs and produces no outputs or modifications. Its sole role is to execute an EXIT statement, returning control to the originating PERFORM statement. There are no business logic decisions, validations, error checks, or subordinate calls. It ensures modular flow control by cleanly terminating the procedure after subordinate processing completes. It is invoked implicitly via THRU 8000-EXIT in the PERFORM statements of 8000-WRITE-AUTH-TO-DB. This prevents fall-through and maintains program structure.",
        "called_by": [],
        "calls": [],
        "citation": [
          794,
          797
        ],
        "outgoing_calls": [],
        "incoming_calls": [],
        "is_dead_code": false,
        "dead_code_reason": null,
        "metadata": null
      },
      {
        "paragraph_name": "8400-UPDATE-SUMMARY",
        "summary": null,
        "purpose": "This paragraph manages the update or insertion of the pending authorization summary segment in IMS PAUTSUM0. It reads flags NFOUND-PAUT-SMRY-SEG and FOUND-PAUT-SMRY-SEG from prior IMS positioning, XREF-ACCT-ID/CUST-ID, ACCT credit limits, AUTH-RESP-APPROVED, WS-APPROVED-AMT, and PA-TRANSACTION-AMT. It produces an updated or new PENDING-AUTH-SUMMARY record written to IMS via REPL or ISRT, accumulating stats in PA-APPROVED-AUTH-CNT/AMT, PA-DECLINED-AUTH-CNT/AMT, PA-CREDIT-BALANCE, PA-CASH-BALANCE. Business logic: if not found, initialize summary and set IDs; always set limits; if approved add to approved stats and adjust balances, else add to declined; then REPL if found else ISRT. Error handling: if DLI fails (STATUS-OK false), set 'I003' error, CRITICAL/IMS flags, IMS-RETURN-CODE, message, card num key, PERFORM 9500-LOG-ERROR. Calls 9500-LOG-ERROR on IMS failure. Exits via 8400-EXIT.",
        "called_by": [],
        "calls": [
          "9500-LOG-ERROR"
        ],
        "citation": [
          798,
          849
        ],
        "outgoing_calls": [],
        "incoming_calls": [],
        "is_dead_code": false,
        "dead_code_reason": null,
        "metadata": null
      },
      {
        "paragraph_name": "8400-EXIT",
        "summary": null,
        "purpose": "This paragraph acts as the exit for 8400-UPDATE-SUMMARY. It performs no data reads, writes, or modifications. Its purpose is to issue an EXIT statement returning control to the caller. No conditions, validations, or error handling occur. No calls are made. It supports THRU clause usage for bounded procedure execution. Ensures no unintended code execution post-summary update.",
        "called_by": [],
        "calls": [],
        "citation": [
          850,
          853
        ],
        "outgoing_calls": [],
        "incoming_calls": [],
        "is_dead_code": false,
        "dead_code_reason": null,
        "metadata": null
      },
      {
        "paragraph_name": "8500-INSERT-AUTH",
        "summary": null,
        "purpose": "This paragraph inserts the authorization detail record into IMS PAUTDTL1 under PAUTSUM0. It consumes PA-RQ-* request fields, PA-RL-* response fields, XREF-ACCT-ID, and computes timestamps from CICS time. It produces a new PENDING-AUTH-DETAILS segment with all auth details, orig dates/times, match status. Business logic: get/format current time via CICS ASKTIME/FORMATTIME, compute inverted date/time stamps, move all request/response/merchant fields, set match pending/declined based on approval, clear fraud fields, set acct ID. Performs DLI ISRT with WHERE ACCNTID. Error handling: if STATUS-OK false, set 'I004' error, CRITICAL/IMS, codes/message/card key, PERFORM 9500-LOG-ERROR. Calls CICS for time and 9500-LOG-ERROR on failure.",
        "called_by": [],
        "calls": [
          "9500-LOG-ERROR"
        ],
        "citation": [
          854,
          934
        ],
        "outgoing_calls": [],
        "incoming_calls": [],
        "is_dead_code": false,
        "dead_code_reason": null,
        "metadata": null
      },
      {
        "paragraph_name": "8500-EXIT",
        "summary": null,
        "purpose": "This is the exit paragraph for 8500-INSERT-AUTH. It executes only an EXIT statement with no data consumption or production. Role is to return control post-insert. No logic, conditions, errors, or calls. Supports THRU for procedure scoping. Prevents flow beyond detail insert.",
        "called_by": [],
        "calls": [],
        "citation": [
          935,
          939
        ],
        "outgoing_calls": [],
        "incoming_calls": [],
        "is_dead_code": false,
        "dead_code_reason": null,
        "metadata": null
      },
      {
        "paragraph_name": "9000-TERMINATE",
        "summary": null,
        "purpose": "This paragraph handles program termination procedures. It consumes IMS-PSB-SCHD flag and WS-REQUEST-MQ-OPEN status. It produces IMS TERM if scheduled and closes MQ queue. Business logic: if PSB scheduled, EXEC DLI TERM; always PERFORM 9100-CLOSE-REQUEST-QUEUE THRU EXIT. No direct validations beyond flags. Errors deferred to 9100. Calls 9100-CLOSE-REQUEST-QUEUE for MQ cleanup. Exits via 9000-EXIT.",
        "called_by": [],
        "calls": [
          "9100-CLOSE-REQUEST-QUEUE"
        ],
        "citation": [
          940,
          949
        ],
        "outgoing_calls": [],
        "incoming_calls": [],
        "is_dead_code": false,
        "dead_code_reason": null,
        "metadata": null
      },
      {
        "paragraph_name": "9000-EXIT",
        "summary": null,
        "purpose": "Exit point for 9000-TERMINATE with single EXIT. No inputs/outputs/logic/calls. Returns control after termination steps. Supports THRU usage.",
        "called_by": [],
        "calls": [],
        "citation": [
          950,
          952
        ],
        "outgoing_calls": [],
        "incoming_calls": [],
        "is_dead_code": false,
        "dead_code_reason": null,
        "metadata": null
      },
      {
        "paragraph_name": "9100-CLOSE-REQUEST-QUEUE",
        "summary": null,
        "purpose": "This paragraph closes the MQ request queue connection. It reads WS-REQUEST-MQ-OPEN flag. Produces MQ close via CALL 'MQCLOSE', sets WS-REQUEST-MQ-CLSE if OK. Business logic: if open, CALL MQCLOSE with HCONN/HOBJ/NONE, check COMPCODE=MQCC-OK. Error handling: if fail, set 'M005' WARNING/MQ errors, codes/message, PERFORM 9500-LOG-ERROR. Calls 'MQCLOSE' API and 9500-LOG-ERROR on failure. Ensures resource cleanup.",
        "called_by": [],
        "calls": [
          "9500-LOG-ERROR"
        ],
        "citation": [
          953,
          978
        ],
        "outgoing_calls": [],
        "incoming_calls": [],
        "is_dead_code": false,
        "dead_code_reason": null,
        "metadata": null
      },
      {
        "paragraph_name": "9100-EXIT",
        "summary": null,
        "purpose": "Exit for 9100-CLOSE-REQUEST-QUEUE via EXIT only. No data ops or logic. Returns post-MQ close.",
        "called_by": [],
        "calls": [],
        "citation": [
          979,
          982
        ],
        "outgoing_calls": [],
        "incoming_calls": [],
        "is_dead_code": false,
        "dead_code_reason": null,
        "metadata": null
      }
    ],
    "error_handling": [
      {
        "condition": "IMS DLI REPL/ISRT summary fails (!STATUS-OK)",
        "action": "MOVE 'I003' TO ERR-LOCATION, SET ERR-CRITICAL/ERR-IMS TRUE, MOVE IMS-RETURN-CODE/'IMS UPDATE SUMRY FAILED'/PA-CARD-NUM, PERFORM 9500-LOG-ERROR",
        "citation": [
          843
        ]
      },
      {
        "condition": "IMS DLI ISRT details fails (!STATUS-OK)",
        "action": "MOVE 'I004' TO ERR-LOCATION, SET ERR-CRITICAL/ERR-IMS TRUE, MOVE IMS-RETURN-CODE/'IMS INSERT DETL FAILED'/PA-CARD-NUM, PERFORM 9500-LOG-ERROR",
        "citation": [
          925
        ]
      },
      {
        "condition": "MQCLOSE fails (WS-COMPCODE != MQCC-OK)",
        "action": "MOVE 'M005' TO ERR-LOCATION, SET ERR-WARNING/ERR-MQ TRUE, MOVE codes/'FAILED TO CLOSE REQUEST MQ', PERFORM 9500-LOG-ERROR",
        "citation": [
          965
        ]
      }
    ],
    "sql_operations": [],
    "cics_operations": [
      {
        "command": "ASKTIME",
        "resource": "ABSTIME(WS-ABS-TIME)",
        "purpose": "Retrieve current absolute time for computing auth timestamp",
        "citation": 860
      },
      {
        "command": "FORMATTIME",
        "resource": "ABSTIME(WS-ABS-TIME) YYDDD(WS-CUR-DATE-X6) TIME(WS-CUR-TIME-X6) MILLISECONDS(WS-CUR-TIME-MS)",
        "purpose": "Format abstime into date/time components for inverted timestamp computation",
        "citation": 865
      }
    ],
    "open_questions": [
      {
        "question": "Source of input data (e.g., where set XREF-*, ACCT-*, PA-RQ-*/PA-RL-*, AUTH-RESP-APPROVED, summary flags)?",
        "context": "Snippet starts at 8000; prior paragraphs not provided",
        "suggestion": "Provide full AST or earlier paragraphs"
      },
      {
        "question": "Copybook definitions for PENDING-AUTH-SUMMARY, PENDING-AUTH-DETAILS, PCBs?",
        "context": "No COPY statements in snippet",
        "suggestion": "Analyze copybooks or full source"
      },
      {
        "question": "Full program flow and entry point?",
        "context": "Only late-stage DB write/terminate shown",
        "suggestion": "Full paragraph list/AST"
      },
      {
        "question": "Details of 9500-LOG-ERROR and IMS-PSB-SCHD?",
        "context": "Referenced but not in snippet",
        "suggestion": "Include those paragraphs"
      }
    ],
    "resolved_questions": [],
    "dead_code": [],
    "call_semantics": [],
    "flow_diagram": null
  },
  "saved_at": "2026-02-25T08:32:51.012887"
}