{
  "header": {
    "program_id": "COPAUS2C",
    "file_name": "COPAUS2C.cbl",
    "file_type": "COBOL",
    "analyzed_by": "WAR_RIG",
    "analyzed_at": "2026-02-03T21:06:56.976223",
    "iteration_count": 1,
    "final_status": null
  },
  "purpose": {
    "summary": "This CICS COBOL program, COPAUS2C, marks an authorization message as fraudulent by inserting a record into the CARDDEMO.AUTHFRDS table. If a record with the same key already exists, it updates the existing record to mark it as fraudulent. The program receives input via the CICS COMMAREA.",
    "business_context": "This program is part of a card authorization system and is used to flag potentially fraudulent transactions.",
    "program_type": "ONLINE_CICS",
    "citations": [
      2,
      5,
      74,
      142,
      223
    ]
  },
  "inputs": [
    {
      "name": "DFHCOMMAREA",
      "io_type": "CICS_COMMAREA",
      "description": "Contains the account ID (WS-ACCT-ID), customer ID (WS-CUST-ID), and fraud authorization record (WS-FRAUD-AUTH-RECORD) which includes authorization details. Also contains the fraud status record (WS-FRAUD-STATUS-RECORD) indicating the action to take (report or remove fraud).",
      "copybook": "CIPAUDTY",
      "citation": [
        74,
        75,
        76,
        77,
        78,
        79,
        80
      ]
    },
    {
      "name": "CARDDEMO.AUTHFRDS",
      "io_type": "DB2_TABLE",
      "description": "This is the DB2 table where fraudulent authorization records are stored. The program either inserts a new record or updates an existing one.",
      "copybook": "AUTHFRDS",
      "citation": [
        142,
        223
      ]
    }
  ],
  "outputs": [
    {
      "name": "CARDDEMO.AUTHFRDS",
      "io_type": "DB2_TABLE",
      "description": "The program inserts or updates records in this table to mark authorization messages as fraudulent.",
      "copybook": null,
      "citation": [
        142,
        223
      ]
    },
    {
      "name": "DFHCOMMAREA",
      "io_type": "CICS_COMMAREA",
      "description": "The COMMAREA is updated with a status message (WS-FRD-ACT-MSG) indicating whether the fraud update was successful or failed.",
      "copybook": null,
      "citation": [
        86,
        201,
        213,
        232,
        241
      ]
    }
  ],
  "called_programs": [],
  "calling_context": {
    "called_by": [],
    "entry_points": [],
    "linkage_section": [
      "DFHCOMMAREA"
    ]
  },
  "business_rules": [
    {
      "rule_id": "BR001",
      "description": "If a record with the same key (CARD_NUM and AUTH_TS) already exists in the AUTHFRDS table, update the AUTH_FRAUD and FRAUD_RPT_DATE columns instead of inserting a new record.",
      "logic_summary": "The program attempts to insert a new record. If SQLCODE is -803 (duplicate key), it performs an update.",
      "conditions": [
        "SQLCODE = -803"
      ],
      "citation": [
        199,
        203,
        204
      ]
    }
  ],
  "data_flow": {
    "reads_from": [
      {
        "source": "DFHCOMMAREA",
        "fields_used": [
          "WS-ACCT-ID",
          "WS-CUST-ID",
          "PA-CARD-NUM",
          "PA-AUTH-ORIG-DATE",
          "PA-AUTH-TIME-9C",
          "PA-AUTH-TYPE",
          "PA-CARD-EXPIRY-DATE",
          "PA-MESSAGE-TYPE",
          "PA-MESSAGE-SOURCE",
          "PA-AUTH-ID-CODE",
          "PA-AUTH-RESP-CODE",
          "PA-AUTH-RESP-REASON",
          "PA-PROCESSING-CODE",
          "PA-TRANSACTION-AMT",
          "PA-APPROVED-AMT",
          "PA-MERCHANT-CATAGORY-CODE",
          "PA-ACQR-COUNTRY-CODE",
          "PA-POS-ENTRY-MODE",
          "PA-MERCHANT-ID",
          "PA-MERCHANT-NAME",
          "PA-MERCHANT-CITY",
          "PA-MERCHANT-STATE",
          "PA-MERCHANT-ZIP",
          "PA-TRANSACTION-ID",
          "PA-MATCH-STATUS"
        ],
        "citation": [
          74,
          75,
          76,
          77,
          78
        ]
      }
    ],
    "writes_to": [
      {
        "destination": "CARDDEMO.AUTHFRDS",
        "fields_written": [
          "CARD_NUM",
          "AUTH_TS",
          "AUTH_TYPE",
          "CARD_EXPIRY_DATE",
          "MESSAGE_TYPE",
          "MESSAGE_SOURCE",
          "AUTH_ID_CODE",
          "AUTH_RESP_CODE",
          "AUTH_RESP_REASON",
          "PROCESSING_CODE",
          "TRANSACTION_AMT",
          "APPROVED_AMT",
          "MERCHANT_CATAGORY_CODE",
          "ACQR_COUNTRY_CODE",
          "POS_ENTRY_MODE",
          "MERCHANT_ID",
          "MERCHANT_NAME",
          "MERCHANT_CITY",
          "MERCHANT_STATE",
          "MERCHANT_ZIP",
          "TRANSACTION_ID",
          "MATCH_STATUS",
          "AUTH_FRAUD",
          "FRAUD_RPT_DATE",
          "ACCT_ID",
          "CUST_ID"
        ],
        "citation": [
          142,
          223
        ]
      },
      {
        "destination": "DFHCOMMAREA",
        "fields_written": [
          "WS-FRD-ACT-MSG"
        ],
        "citation": [
          201,
          213,
          232,
          241
        ]
      }
    ],
    "transforms": [
      {
        "input_field": "PA-AUTH-ORIG-DATE",
        "output_field": "WS-AUTH-YY, WS-AUTH-MM, WS-AUTH-DD",
        "transformation_description": "The PA-AUTH-ORIG-DATE is split into year, month, and day components.",
        "citation": [
          103,
          104,
          105
        ]
      },
      {
        "input_field": "PA-AUTH-TIME-9C",
        "output_field": "WS-AUTH-HH, WS-AUTH-MI, WS-AUTH-SS, WS-AUTH-SSS",
        "transformation_description": "PA-AUTH-TIME-9C is subtracted from 999999999, then split into hours, minutes, seconds, and milliseconds.",
        "citation": [
          107,
          108,
          109,
          110,
          111
        ]
      }
    ]
  },
  "copybooks_used": [
    {
      "copybook_name": "DFHBMSCA",
      "purpose": "CICS BMS copybook (not actually used in the code)",
      "location": "WORKING_STORAGE",
      "citation": 61
    },
    {
      "copybook_name": "SQLCA",
      "purpose": "SQL Communications Area for DB2 interaction.",
      "location": "WORKING_STORAGE",
      "citation": 66
    },
    {
      "copybook_name": "AUTHFRDS",
      "purpose": "Defines the structure of the AUTHFRDS table in DB2.",
      "location": "WORKING_STORAGE",
      "citation": 69
    },
    {
      "copybook_name": "CIPAUDTY",
      "purpose": "Defines the structure of the fraud authorization record passed in the COMMAREA.",
      "location": "LINKAGE",
      "citation": 78
    }
  ],
  "paragraphs": [
    {
      "paragraph_name": "MAIN-PARA",
      "summary": null,
      "purpose": "This is the main paragraph of the COPAUS2C program. It begins by retrieving the current date and time using CICS ASKTIME and FORMATTIME commands and storing them in WS-ABS-TIME and WS-CUR-DATE respectively. The current date is then moved to PA-FRAUD-RPT-DATE. The authorization date and time from the input COMMAREA (PA-AUTH-ORIG-DATE and PA-AUTH-TIME-9C) are transformed and moved to WS-AUTH-TS. The program then moves data from the input COMMAREA (WS-FRAUD-AUTH-RECORD) to corresponding fields used in the SQL INSERT statement. The program attempts to insert a new record into the CARDDEMO.AUTHFRDS table with the provided information. If the insert is successful (SQLCODE = ZERO), it sets WS-FRD-UPDT-SUCCESS to TRUE and moves 'ADD SUCCESS' to WS-FRD-ACT-MSG. If the insert fails due to a duplicate key (SQLCODE = -803), the program calls the FRAUD-UPDATE paragraph to update the existing record. If any other SQL error occurs, the program sets WS-FRD-UPDT-FAILED to TRUE, moves the SQLCODE and SQLSTATE to WS-SQLCODE and WS-SQLSTATE, and constructs an error message in WS-FRD-ACT-MSG. Finally, the program returns to the calling program using EXEC CICS RETURN.",
      "called_by": [],
      "calls": [
        "FRAUD-UPDATE"
      ],
      "citation": [
        89,
        220
      ],
      "outgoing_calls": [
        {
          "target": "FRAUD-UPDATE",
          "call_type": "performs",
          "line": 204
        },
        {
          "target": "CARDDEMO.AUTHFRDS",
          "call_type": "writes",
          "line": 141
        }
      ],
      "incoming_calls": [],
      "is_dead_code": false,
      "dead_code_reason": null,
      "metadata": {
        "body_chunks": 2
      }
    },
    {
      "paragraph_name": "FRAUD-UPDATE",
      "summary": null,
      "purpose": "This paragraph updates an existing record in the CARDDEMO.AUTHFRDS table. It sets the AUTH_FRAUD and FRAUD_RPT_DATE columns for the record matching the CARD_NUM and AUTH_TS from the input COMMAREA. The AUTH_TS is formatted using TIMESTAMP_FORMAT. If the update is successful (SQLCODE = ZERO), it sets WS-FRD-UPDT-SUCCESS to TRUE and moves 'UPDT SUCCESS' to WS-FRD-ACT-MSG. If the update fails, it sets WS-FRD-UPDT-FAILED to TRUE, moves the SQLCODE and SQLSTATE to WS-SQLCODE and WS-SQLSTATE, and constructs an error message in WS-FRD-ACT-MSG. This paragraph is called by MAIN-PARA when an INSERT statement fails due to a duplicate key.",
      "called_by": [
        "MAIN-PARA"
      ],
      "calls": [],
      "citation": [
        221,
        244
      ],
      "outgoing_calls": [
        {
          "target": "CARDDEMO.AUTHFRDS",
          "call_type": "updates",
          "line": 222
        }
      ],
      "incoming_calls": [
        {
          "file": "/home/andras/aws-mainframe-modernization-carddemo/app/app-authorization-ims-db2-mq/cbl/COPAUS2C.cbl",
          "function": "MAIN-PARA",
          "line": 204,
          "call_type": "performs"
        }
      ],
      "is_dead_code": false,
      "dead_code_reason": null,
      "metadata": null
    }
  ],
  "error_handling": [
    {
      "condition": "SQLCODE not ZERO and SQLCODE = -803",
      "action": "PERFORM FRAUD-UPDATE to update the existing record.",
      "citation": [
        203,
        204
      ]
    },
    {
      "condition": "SQLCODE not ZERO and SQLCODE not -803",
      "action": "Set WS-FRD-UPDT-FAILED to TRUE and construct an error message in WS-FRD-ACT-MSG with the SQLCODE and SQLSTATE.",
      "citation": [
        206,
        208,
        209,
        211,
        212,
        213
      ]
    },
    {
      "condition": "SQLCODE not ZERO in FRAUD-UPDATE",
      "action": "Set WS-FRD-UPDT-FAILED to TRUE and construct an error message in WS-FRD-ACT-MSG with the SQLCODE and SQLSTATE.",
      "citation": [
        234,
        236,
        237,
        239,
        240,
        241
      ]
    }
  ],
  "sql_operations": [
    {
      "operation": "INSERT",
      "table": "CARDDEMO.AUTHFRDS",
      "purpose": "To add a new fraudulent authorization record.",
      "citation": 142
    },
    {
      "operation": "UPDATE",
      "table": "CARDDEMO.AUTHFRDS",
      "purpose": "To update an existing fraudulent authorization record when a duplicate key is encountered during insertion.",
      "citation": 223
    }
  ],
  "cics_operations": [
    {
      "command": "ASKTIME",
      "resource": null,
      "purpose": "To get the current absolute time.",
      "citation": 91
    },
    {
      "command": "FORMATTIME",
      "resource": null,
      "purpose": "To format the absolute time into a readable date format.",
      "citation": 95
    },
    {
      "command": "RETURN",
      "resource": null,
      "purpose": "To return control to the calling program.",
      "citation": 218
    }
  ],
  "open_questions": [
    {
      "question": "What is the structure of the CIPAUDTY copybook?",
      "context": "The copybook is used to define the WS-FRAUD-AUTH-RECORD, but the contents are not available in the provided code.",
      "suggestion": "The CIPAUDTY copybook needs to be provided to fully understand the structure of the input COMMAREA."
    }
  ],
  "dead_code": [],
  "call_semantics": [
    {
      "caller": "MAIN-PARA",
      "callee": "FRAUD-UPDATE",
      "inputs": [
        "CARD-NUM",
        "AUTH-TS",
        "AUTH-FRAUD"
      ],
      "outputs": [
        "WS-FRD-UPDT-SUCCESS",
        "WS-FRD-ACT-MSG",
        "WS-SQLCODE",
        "WS-SQLSTATE"
      ],
      "purpose": "Updates the fraud status and report date for an existing authorization record in the AUTHFRDS table when a duplicate key error occurs during insert."
    }
  ],
  "flow_diagram": "flowchart TD\n    %% Title: COPAUS2C.cbl\n    FRAUD_UPDATE[\"FRAUD-UPDATE\"]\n    CARDDEMO_AUTHFRDS__ext[(\"CARDDEMO.AUTHFRDS\")]\n    MAIN_PARA[\"MAIN-PARA\"]\n    FRAUD_UPDATE -.->|updates| CARDDEMO_AUTHFRDS__ext\n    MAIN_PARA --> FRAUD_UPDATE\n    MAIN_PARA -.->|writes| CARDDEMO_AUTHFRDS__ext"
}